<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Spatial Modelling for Data Scientists - 8&nbsp; Multilevel modelling</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./08-weighted-regression-modelling.html" rel="next">
<link href="./06-spatial-heterogeneity.html" rel="prev">
<link href="./figs/cover/cover.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
<meta name="twitter:title" content="Spatial Modelling for Data Scientists - 8&nbsp; Multilevel modelling">
<meta name="twitter:description" content="This chapter provides an introduction to multi-level data structures and multi-level modelling and draws on the following references:">
<meta name="twitter:creator" content="@fcorowe">
<meta name="twitter:card" content="summary">
</head>
<body class="nav-sidebar docked slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">
<span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Multilevel modelling</span>
</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Spatial Modelling for Data Scientists</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/fcorowe/smds/tree/main/book/" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
<li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
    </ul>
<a href="" class="quarto-reader-toggle sidebar-tool" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Part I</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preamble.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Framing this book</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-embedding-space.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Embedding space</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-spatial-data-wrangling.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial data wrangling</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Part II</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-points.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Point data analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-spatial-interaction-model.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial interaction modelling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-spatial-dependence.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatial dependence</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">Part III</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-spatial-heterogeneity.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Spatial heterogeneity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-multilevel-modelling.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Multilevel modelling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-weighted-regression-modelling.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Geographically weighted regression modelling</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">Part IV</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-spatio-temporal-wrangling.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Spatiotemporal wrangling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-spatio-temporal-modelling.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Spatiotemporal modelling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-spatial-machine-learning.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatial machine learning</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./platform.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Platform</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#dependencies" id="toc-dependencies" class="nav-link active" data-scroll-target="#dependencies"><span class="toc-section-number">8.1</span>  Dependencies</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data"><span class="toc-section-number">8.2</span>  Data</a></li>
  <li>
<a href="#modelling" id="toc-modelling" class="nav-link" data-scroll-target="#modelling"><span class="toc-section-number">8.3</span>  Modelling</a>
  <ul class="collapse">
<li><a href="#baseline-linear-regression-model" id="toc-baseline-linear-regression-model" class="nav-link" data-scroll-target="#baseline-linear-regression-model"><span class="toc-section-number">8.3.1</span>  Baseline Linear Regression Model</a></li>
  </ul>
</li>
  <li>
<a href="#multilevel-modelling-random-intercept-model" id="toc-multilevel-modelling-random-intercept-model" class="nav-link" data-scroll-target="#multilevel-modelling-random-intercept-model"><span class="toc-section-number">8.4</span>  Multilevel Modelling: Random Intercept Model</a>
  <ul class="collapse">
<li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation"><span class="toc-section-number">8.4.1</span>  Interpretation</a></li>
  <li><a href="#variance-partition-coefficient-vpc" id="toc-variance-partition-coefficient-vpc" class="nav-link" data-scroll-target="#variance-partition-coefficient-vpc"><span class="toc-section-number">8.4.2</span>  Variance Partition Coefficient (VPC)</a></li>
  <li><a href="#uncertainty-of-estimates" id="toc-uncertainty-of-estimates" class="nav-link" data-scroll-target="#uncertainty-of-estimates"><span class="toc-section-number">8.4.3</span>  Uncertainty of Estimates</a></li>
  <li><a href="#assessing-group-level-variation" id="toc-assessing-group-level-variation" class="nav-link" data-scroll-target="#assessing-group-level-variation"><span class="toc-section-number">8.4.4</span>  Assessing Group-level Variation</a></li>
  <li><a href="#sec-indlevel" id="toc-sec-indlevel" class="nav-link" data-scroll-target="#sec-indlevel"><span class="toc-section-number">8.4.5</span>  Adding Individual-level Predictors</a></li>
  <li><a href="#sec-grouplevel" id="toc-sec-grouplevel" class="nav-link" data-scroll-target="#sec-grouplevel"><span class="toc-section-number">8.4.6</span>  Adding Group-level Predictors</a></li>
  </ul>
</li>
  <li><a href="#questions" id="toc-questions" class="nav-link" data-scroll-target="#questions"><span class="toc-section-number">8.5</span>  Questions</a></li>
  <li><a href="#dependencies-1" id="toc-dependencies-1" class="nav-link" data-scroll-target="#dependencies-1"><span class="toc-section-number">8.6</span>  Dependencies</a></li>
  <li><a href="#data-1" id="toc-data-1" class="nav-link" data-scroll-target="#data-1"><span class="toc-section-number">8.7</span>  Data</a></li>
  <li>
<a href="#conceptual-overview" id="toc-conceptual-overview" class="nav-link" data-scroll-target="#conceptual-overview"><span class="toc-section-number">8.8</span>  Conceptual Overview</a>
  <ul class="collapse">
<li><a href="#exploratory-analysis-varying-slopes" id="toc-exploratory-analysis-varying-slopes" class="nav-link" data-scroll-target="#exploratory-analysis-varying-slopes"><span class="toc-section-number">8.8.1</span>  Exploratory Analysis: Varying Slopes</a></li>
  </ul>
</li>
  <li><a href="#estimating-varying-intercept-and-slopes-models" id="toc-estimating-varying-intercept-and-slopes-models" class="nav-link" data-scroll-target="#estimating-varying-intercept-and-slopes-models"><span class="toc-section-number">8.9</span>  Estimating Varying Intercept and Slopes Models</a></li>
  <li><a href="#interpreting-correlations-between-group-level-intercepts-and-slopes" id="toc-interpreting-correlations-between-group-level-intercepts-and-slopes" class="nav-link" data-scroll-target="#interpreting-correlations-between-group-level-intercepts-and-slopes"><span class="toc-section-number">8.10</span>  Interpreting Correlations Between Group-level Intercepts and Slopes</a></li>
  <li>
<a href="#model-building" id="toc-model-building" class="nav-link" data-scroll-target="#model-building"><span class="toc-section-number">8.11</span>  Model building</a>
  <ul class="collapse">
<li><a href="#model-comparison" id="toc-model-comparison" class="nav-link" data-scroll-target="#model-comparison"><span class="toc-section-number">8.11.1</span>  Model Comparison</a></li>
  </ul>
</li>
  <li><a href="#questions-1" id="toc-questions-1" class="nav-link" data-scroll-target="#questions-1"><span class="toc-section-number">8.12</span>  Questions</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/fcorowe/smds/edit/main/book/07-multilevel-modelling.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/fcorowe/smds/issues/new" class="toc-action">Report an issue</a></p><p><a href="https://github.com/fcorowe/smds/blob/main/book/07-multilevel-modelling.qmd" class="toc-action">View source</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title d-none d-lg-block">
<span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Multilevel modelling</span>
</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>This chapter provides an introduction to multi-level data structures and multi-level modelling and draws on the following references:</p>
<ul>
<li>
<span class="citation" data-cites="gelman2006data">Gelman and Hill (<a href="references.html#ref-gelman2006data" role="doc-biblioref">2006</a>)</span> provides an excellent and intuitive explanation of multilevel modelling and data analysis in general. Read Part 2A for a really good explanation of multilevel models.</li>
<li>
<span class="citation" data-cites="bristol2020">Multilevel Modelling (<a href="references.html#ref-bristol2020" role="doc-biblioref">n.d.</a>)</span> is an useful online resource on multilevel modelling and is free!</li>
</ul>
<section id="dependencies" class="level2" data-number="8.1"><h2 data-number="8.1" class="anchored" data-anchor-id="dependencies">
<span class="header-section-number">8.1</span> Dependencies</h2>
<p>This chapter uses the following libraries which are listed in the [Dependency list] Section of Chapter 1:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Data manipulation, transformation and visualisation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co"># Nice tables</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span></span>
<span><span class="co"># Simple features (a standardised way to encode vector data ie. points, lines, polygons)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span> </span>
<span><span class="co"># Spatial objects conversion</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/sp/">sp</a></span><span class="op">)</span> </span>
<span><span class="co"># Thematic maps</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-tmap/tmap">tmap</a></span><span class="op">)</span> </span>
<span><span class="co"># Colour palettes</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span> </span>
<span><span class="co"># More colour palettes</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/">viridis</a></span><span class="op">)</span> <span class="co"># nice colour schemes</span></span>
<span><span class="co"># Fitting multilevel models</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="co"># Tools for extracting information generated by lme4</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">merTools</span><span class="op">)</span></span>
<span><span class="co"># Exportable regression tables</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jtools.jacob-long.com">jtools</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">stargazer</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://strengejacke.github.io/sjPlot/">sjPlot</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="data" class="level2 page-columns page-full" data-number="8.2"><h2 data-number="8.2" class="anchored" data-anchor-id="data">
<span class="header-section-number">8.2</span> Data</h2>
<div class="page-columns page-full"><p>For this chapter, we will data for Liverpool from England’s 2011 Census. The original source is the <a href="https://www.nomisweb.co.uk/home/census2001.asp">Office of National Statistics</a> and the dataset comprises a number of selected variables capturing demographic, health and socio-economic attributes of the local resident population at four geographic levels: Output Area (OA), Lower Super Output Area (LSOA), Middle Super Output Area (MSOA) and Local Authority District (LAD). The variables include population counts and percentages. For a description of the variables, see the readme file in the mlm data folder.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;Read the file in R by executing <code>read_tsv("data/mlm/readme.txt")</code> . Ensure the library <code>readr</code> is installed before running <code>read_tsv</code>.</p></li></div></div>
<p>Let us read the data:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># clean workspace</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># read data</span></span>
<span><span class="va">oa_shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/mlm/OA.shp"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now attach and visualise the structure of the data.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># attach data frame</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/attach.html">attach</a></span><span class="op">(</span><span class="va">oa_shp</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from package:viridis:

    unemp</code></pre>
</div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># sort data by oa</span></span>
<span><span class="va">oa_shp</span> <span class="op">&lt;-</span> <span class="va">oa_shp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">oa_cd</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">oa_shp</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 19 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 335056 ymin: 389163 xmax: 336155 ymax: 389642
Projected CRS: Transverse_Mercator
      oa_cd   lsoa_cd   msoa_cd    lad_cd      ward_nm  dstrt_nm    cnty_nm
1 E00032987 E01006515 E02001383 E08000012    Riverside Liverpool Merseyside
2 E00032988 E01006514 E02001383 E08000012 Princes Park Liverpool Merseyside
3 E00032989 E01033768 E02001383 E08000012 Princes Park Liverpool Merseyside
4 E00032990 E01033768 E02001383 E08000012 Princes Park Liverpool Merseyside
5 E00032991 E01033768 E02001383 E08000012 Princes Park Liverpool Merseyside
6 E00032992 E01033768 E02001383 E08000012 Princes Park Liverpool Merseyside
  cntry_nm pop     age_60     unemp      lat      long    males   lt_ill
1  England 198 0.11616162 0.1130435 53.39821 -2.976786 46.46465 19.19192
2  England 348 0.16954023 0.1458333 53.39813 -2.969072 58.33333 33.62069
3  England 333 0.09009009 0.1049724 53.39778 -2.965290 64.26426 23.72372
4  England 330 0.15151515 0.1329787 53.39802 -2.963597 59.69697 23.03030
5  England 320 0.04687500 0.1813725 53.39706 -2.968030 60.62500 25.00000
6  England 240 0.05833333 0.2519685 53.39679 -2.966494 57.91667 28.33333
    Bhealth VBhealth  no_qual   manprof                       geometry
1  6.565657 1.515152 24.69136  7.643312 MULTIPOLYGON (((335187 3894...
2 10.344828 1.436782 14.84848 13.375796 MULTIPOLYGON (((335834 3895...
3  6.606607 2.102102 15.38462 10.204082 MULTIPOLYGON (((335975.2 38...
4  5.151515 2.424242 17.91531 15.224913 MULTIPOLYGON (((336030.8 38...
5  8.750000 2.187500 12.58278 11.333333 MULTIPOLYGON (((335804.9 38...
6  6.666667 2.916667 27.47748  5.479452 MULTIPOLYGON (((335804.9 38...</code></pre>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="figs/ch5/datastr.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Fig. 1. Data Structure.</figcaption><p></p>
</figure>
</div>
<p>The data are hierarchically structured: OAs nested within LSOAs; LSOAs nested within MSOAs; and, MSOAs nested within LADs. Observations nested within higher geographical units may be correlated.</p>
<p>This is one type of hierarchical structure. There is a range of data structures:</p>
<ul>
<li><p>Strict nested data structures eg. an individual unit is nested within only one higher unit</p></li>
<li><p>Repeated measures structures eg. various measurements for an individual unit</p></li>
<li><p>Crossed classified structures eg. individuals may work and live in different neighbourhoods</p></li>
<li><p>Multiple membership structure eg. individuals may have two different work places</p></li>
</ul>
<p><em>Why should we care about the structure of the data?</em></p>
<ul>
<li><p><em>Draw correct statistical inference</em>: Failing to recognise hierarchical structures will lead to underestimated standard errors of regression coefficients and an overstatement of statistical significance. Standard errors for the coefficients of higher-level predictor variables will be the most affected by ignoring grouping.</p></li>
<li><p><em>Link context to individual units</em>: We can link and understand the extent of group effects on individual outcomes eg. how belonging to a certain socio-economic group influences on future career opportunities.</p></li>
<li><p><em>Spatial dependency</em>: Recognising the hierarchical structure of data may help mitigate the effects of severe spatial autocorrelation.</p></li>
</ul>
<p>Quickly, let us get a better idea about the data and look at the number of OAs nested within LSOAs and MSOAs</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># mean of nested OAs within LSOAs and MSOAs</span></span>
<span><span class="va">lsoa_cd</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span>, <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5</code></pre>
</div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">msoa_cd</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span>, <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 26</code></pre>
</div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># number of OAs nested within LSOAs and MSOAs</span></span>
<span><span class="va">lsoa_cd</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07-multilevel-modelling_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">msoa_cd</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07-multilevel-modelling_files/figure-html/unnamed-chunk-4-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="modelling" class="level2" data-number="8.3"><h2 data-number="8.3" class="anchored" data-anchor-id="modelling">
<span class="header-section-number">8.3</span> Modelling</h2>
<p>We should now be persuaded that ignoring the hierarchical structure of data may be a major issue. Let us now use a simple example to understand the intuition of multilevel model using the census data. We will seek to understand the spatial distribution of the proportion of population in unemployment in Liverpool, particularly why and where concentrations in this proportion occur. To illustrate the advantages of taking a multilevel modelling approach, we will start by estimating a linear regression model and progressively building complexity. We will first estimate a model and then explain the intuition underpinning the process. We will seek to gain a general understanding of multilevel modelling. If you are interested in the statistical and mathemathical formalisation of the underpinning concepts, please refer to <span class="citation" data-cites="gelman2006data">Gelman and Hill (<a href="references.html#ref-gelman2006data" role="doc-biblioref">2006</a>)</span>.</p>
<p>We first need to want to understand our dependent variable: its density ditribution;</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">oa_shp</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0.8</span>, colour<span class="op">=</span><span class="st">"black"</span>, fill<span class="op">=</span><span class="st">"lightblue"</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">unemp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07-multilevel-modelling_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">unemp</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
0.00000 0.05797 0.10256 0.11581 0.16129 0.50000 </code></pre>
</div>
</div>
<p>and, its spatial distribution:</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># ensure geometry is valid</span></span>
<span><span class="va">oa_shp</span> <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html">st_make_valid</a></span><span class="op">(</span><span class="va">oa_shp</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a map</span></span>
<span><span class="va">legend_title</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="st">"% unemployment"</span><span class="op">)</span></span>
<span><span class="va">map_oa</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">oa_shp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_fill</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"unemp"</span>, title <span class="op">=</span> <span class="va">legend_title</span>, palette <span class="op">=</span> <span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html">magma</a></span><span class="op">(</span><span class="fl">256</span>, begin <span class="op">=</span> <span class="fl">0.25</span>, end <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, style <span class="op">=</span> <span class="st">"cont"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_borders</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"white"</span>, lwd <span class="op">=</span> <span class="fl">.01</span><span class="op">)</span>  <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_compass.html">tm_compass</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"arrow"</span>, position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"right"</span>, <span class="st">"top"</span><span class="op">)</span> , size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_scale_bar.html">tm_scale_bar</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, text.size <span class="op">=</span> <span class="fl">0.5</span>, position <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"center"</span>, <span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">map_oa</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07-multilevel-modelling_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Let us look at those areas:</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># high %s</span></span>
<span><span class="va">oa_shp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">unemp</span> <span class="op">&gt;</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">oa_cd</span>, <span class="va">pop</span>, <span class="va">unemp</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 203 features and 3 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 333993.8 ymin: 379748.5 xmax: 345600.2 ymax: 397681.5
Projected CRS: Transverse_Mercator
First 10 features:
       oa_cd pop     unemp                       geometry
1  E00032992 240 0.2519685 POLYGON ((335804.9 389421.6...
2  E00033008 345 0.2636364 POLYGON ((335080 388528, 33...
3  E00033074 299 0.2075472 POLYGON ((336947.3 387766.7...
4  E00033075 254 0.2288136 POLYGON ((336753.6 387465.2...
5  E00033080 197 0.2647059 POLYGON ((338196 387079, 33...
6  E00033103 298 0.2148148 POLYGON ((340484 385429.6, ...
7  E00033116 190 0.2156863 POLYGON ((341960.7 386422.1...
8  E00033134 190 0.2674419 POLYGON ((337137 393089.6, ...
9  E00033137 289 0.2661290 POLYGON ((337363.8 392122.4...
10 E00033138 171 0.3561644 POLYGON ((337481.5 392166.2...</code></pre>
</div>
</div>
<section id="baseline-linear-regression-model" class="level3" data-number="8.3.1"><h3 data-number="8.3.1" class="anchored" data-anchor-id="baseline-linear-regression-model">
<span class="header-section-number">8.3.1</span> Baseline Linear Regression Model</h3>
<p>Now let us estimate a simple linear regression model with the intercept only:</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># specify a model equation</span></span>
<span><span class="va">eq1</span> <span class="op">&lt;-</span> <span class="va">unemp</span> <span class="op">~</span> <span class="fl">1</span></span>
<span><span class="va">model1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">eq1</span>, data <span class="op">=</span> <span class="va">oa_shp</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># estimates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = eq1, data = oa_shp)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.11581 -0.05784 -0.01325  0.04548  0.38419 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 0.115812   0.001836   63.09   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.07306 on 1583 degrees of freedom</code></pre>
</div>
</div>
<p>To understand the differences between the linear regression model and multilevel models, let us consider the model we have estimated:</p>
<p><span class="math display">\[y_{i} = \beta_{0} + e_{i}\]</span> where <span class="math inline">\(y_{i}\)</span> represents the proportion of the unemployed resident population in the OA <span class="math inline">\(i\)</span>; <span class="math inline">\(\beta_{0}\)</span> is the regression intercept and measures the average proportion of the unemployed resident population across OAs; and, <span class="math inline">\(e_{i}\)</span> is the error term. But how do we deal with the hierarchical structure of the data?</p>
<section id="limitations" class="level4" data-number="8.3.1.1"><h4 data-number="8.3.1.1" class="anchored" data-anchor-id="limitations">
<span class="header-section-number">8.3.1.1</span> Limitations</h4>
<p>Before looking at the answer, let’s first understand some of the key limitations of the linear regression model to handle the hierarchical structure of data. A key limitation of the linear regression model is that it only captures average relationships in the data. It does not capture variations in the relationship between variables across areas or groups. Another key limitation is that the linear regression model can capture associations at either macro or micro levels, but it does not simultaneously measure their interdependencies.</p>
<p>To illustrate this, let us consider the regression intercept. It indicates that the average percentage of unemployed population at the OA level is 0.12 but this model ignores any spatial clustering ie. the percentage of unemployed population tends to be similar across OAs nested within a same LSOA or MSOA. A side effect of ignoring this is that our standard errors are biased, and thus claims about statistical significance based on them would be misleading. Additionally, this situation also means we cannot explore variations in the percentage of unemployed population across LSOAs or MSOAs ie. how the percentage of unemployed population may be dependent on various contextual factors at these geographical scales.</p>
</section><section id="fixed-effect-approach" class="level4" data-number="8.3.1.2"><h4 data-number="8.3.1.2" class="anchored" data-anchor-id="fixed-effect-approach">
<span class="header-section-number">8.3.1.2</span> Fixed Effect Approach</h4>
<p>An alternative approach is to adopt a fixed effects approach, or no-pooling model; that is, adding dummy variables indicating the group classification into the regression model eg. the way OAs is nested within LSOAs (or MSOAs). This approach has limitations. First, there is high risk of overfitting. The number of groups may be too large, relative to the number of observations. Second, the estimation of multiple parameters may be required so that measuring differences between groups may be challenging. Third, a fixed effects approach does not allow including group-level explanatory variables. You can try fitting a linear regression model extending our estimated model to include dummy variables for individual LSOAs (and/or MSOAs) so you can compare this to the multilevel model below.</p>
<p>An alternative is fitting separate linear regression models for each group. This approach is not always possible if there are groups with small sizes.</p>
</section></section></section><section id="multilevel-modelling-random-intercept-model" class="level2 page-columns page-full" data-number="8.4"><h2 data-number="8.4" class="anchored" data-anchor-id="multilevel-modelling-random-intercept-model">
<span class="header-section-number">8.4</span> Multilevel Modelling: Random Intercept Model</h2>
<p>We use multilevel modelling to account for the hierarchical nature of the data by explicitly recognising that OAs are nested within LSOAs and MSOAs. Multilevel models can easily be estimated using in R using the package <code>lme4</code>. We implement an two-level model to allow for variation across LSOAs. We estimate an only intercept model allowing for variation across LSOAs. In essence, we are estimating a model with varying intercept coefficient by LSOA. As you can see in the code chunk below, the equation has an additional component. This is the group component or LSOA effect. The <code>(1 | lsoa_cd)</code> means that we are allowing the intercept, represented by 1, to vary by LSOA.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># specify a model equation</span></span>
<span><span class="va">eq2</span> <span class="op">&lt;-</span> <span class="va">unemp</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">lsoa_cd</span><span class="op">)</span></span>
<span><span class="va">model2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">eq2</span>, data <span class="op">=</span> <span class="va">oa_shp</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># estimates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: unemp ~ 1 + (1 | lsoa_cd)
   Data: oa_shp

REML criterion at convergence: -4382.6

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-2.8741 -0.5531 -0.1215  0.4055  5.8207 

Random effects:
 Groups   Name        Variance Std.Dev.
 lsoa_cd  (Intercept) 0.002701 0.05197 
 Residual             0.002575 0.05074 
Number of obs: 1584, groups:  lsoa_cd, 298

Fixed effects:
            Estimate Std. Error t value
(Intercept) 0.114316   0.003277   34.89</code></pre>
</div>
</div>
<p>We can estimate a three-level model by adding <code>(1 | msoa_cd)</code> to allow the intercept to also vary by MSOAs and account for the nesting structure of LSOAs within MSOAs.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># specify a model equation</span></span>
<span><span class="va">eq3</span> <span class="op">&lt;-</span> <span class="va">unemp</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">lsoa_cd</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">msoa_cd</span><span class="op">)</span></span>
<span><span class="va">model3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">eq3</span>, data <span class="op">=</span> <span class="va">oa_shp</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># estimates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: unemp ~ 1 + (1 | lsoa_cd) + (1 | msoa_cd)
   Data: oa_shp

REML criterion at convergence: -4529.3

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-2.5624 -0.5728 -0.1029  0.4228  6.1363 

Random effects:
 Groups   Name        Variance  Std.Dev.
 lsoa_cd  (Intercept) 0.0007603 0.02757 
 msoa_cd  (Intercept) 0.0020735 0.04554 
 Residual             0.0025723 0.05072 
Number of obs: 1584, groups:  lsoa_cd, 298; msoa_cd, 61

Fixed effects:
            Estimate Std. Error t value
(Intercept) 0.115288   0.006187   18.64</code></pre>
</div>
</div>
<p>We see two sets of coefficients: <em>fixed effects</em> and <em>random effects</em>. <em>Fixed effects</em> correspond to the standard linear regression coefficients. Their interpretation is as usual. <em>Random effects</em> are the novelty. It is a term in multilevel modelling and refers to varying coefficients i.e.&nbsp;the randomness in the probability of the model for the group-level coefficients. Specifically they relate to estimates of the average variance and standard deviation within groups (i.e.&nbsp;LSOAs or MSOAs). Intiutively, variance and standard deviation indicate the extent to which the intercept, on average, varies by LSOAs and MSOAs.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="figs/ch5/nm_dist_obs.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Fig. 2. Variation of observations around their level 1 group mean.</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="figs/ch5/nm_dist_msoa.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Fig. 3. Variation of level 1 group mean around their level 2 group mean.</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="figs/ch5/nm_dist_grand.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Fig. 4. Grand mean.</figcaption><p></p>
</figure>
</div>
<p>More formally, we first estimated the simplest regression model which is an intercept-only model and equivalent to the sample mean (i.e.&nbsp;the <em>fixed</em> part of the model):</p>
<p><span class="math display">\[y_{ijk} = \mu + e_{ijk}\]</span> and then we made the <em>random</em> part of the model (<span class="math inline">\(e_{ijk}\)</span>) more complex to account for the hierarchical structure of the data by estimating the following three-level regression model:</p>
<p><span class="math display">\[y_{ijk} = \mu + u_{i..} + u_{ij.} + e_{ijk}\]</span></p>
<p>where <span class="math inline">\(y_{ijk}\)</span> represents the proportion of unemployed population in OA <span class="math inline">\(i\)</span> nested within LSOA <span class="math inline">\(j\)</span> and MSOA <span class="math inline">\(k\)</span>; <span class="math inline">\(\mu\)</span> represents the sample mean and the <em>fixed</em> part of the model; <span class="math inline">\(e_{ijk}\)</span> is the deviation of an observation from its LSOA mean; <span class="math inline">\(u_{ij.}\)</span> is the deviation of the LSOA mean from its MSOA mean; <span class="math inline">\(u_{i..}\)</span> is the deviation of the MSOA mean from the fixed part of the model <span class="math inline">\(\mu\)</span>. Conceptually, this model is decomposing the variance of the model in terms of the hierarchical structure of the data. It is partitioning the observation’s residual into three parts or <em>variance components</em>. These components measure the relative extent of variation of each hierarchical level ie. LSOA, MSOA and grand means. To estimate the set of residuals, they are assumed to follow a normal distribution and are obtained after fitting the model and are based on the estimates of the model parameters (i.e.&nbsp;intercept and variances of the random parameters).</p>
<p>Let’s now return to our three-level model (reported again below), we see that the intercept or fixed part of the model is the same as for the linear regression. The multilevel model reports greater standard errors. Multilevel models capture the hierarchical structure of the data and thus more precisely estimate the standard errors for our parameters.</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># report model 3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: unemp ~ 1 + (1 | lsoa_cd) + (1 | msoa_cd)
   Data: oa_shp

REML criterion at convergence: -4529.3

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-2.5624 -0.5728 -0.1029  0.4228  6.1363 

Random effects:
 Groups   Name        Variance  Std.Dev.
 lsoa_cd  (Intercept) 0.0007603 0.02757 
 msoa_cd  (Intercept) 0.0020735 0.04554 
 Residual             0.0025723 0.05072 
Number of obs: 1584, groups:  lsoa_cd, 298; msoa_cd, 61

Fixed effects:
            Estimate Std. Error t value
(Intercept) 0.115288   0.006187   18.64</code></pre>
</div>
</div>
<section id="interpretation" class="level3" data-number="8.4.1"><h3 data-number="8.4.1" class="anchored" data-anchor-id="interpretation">
<span class="header-section-number">8.4.1</span> Interpretation</h3>
<blockquote class="blockquote">
<p>Fixed effects</p>
</blockquote>
<p>We start by examining the fixed effects or estimated model averaging over LSOAs and MSOAs, <span class="math inline">\(y_{ijk} = 0.115288\)</span> which can also be called by executing:</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/fixed.effects.html">fixef</a></span><span class="op">(</span><span class="va">model3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) 
  0.1152881 </code></pre>
</div>
</div>
<p>Th estimated intercept indicates that the overall mean taken across LSOAs and MSOAs is estimated as <code>0.115288</code> and is statistically significant at <code>5%</code> significance.</p>
<blockquote class="blockquote">
<p>Random effects</p>
</blockquote>
<p>The set of random effects contains three estimates of variance and standard deviation and refer to the variance components discussed above. The <code>lsoa_cd</code>, <code>msoa_cd</code> and <code>Residual</code> estimates indicate that the extent of estimated LSOA-, MSOA- and individual-level variance is <code>0.0007603</code>, <code>0.0020735</code> and <code>0.0025723</code>, respectively.</p>
</section><section id="variance-partition-coefficient-vpc" class="level3 page-columns page-full" data-number="8.4.2"><h3 data-number="8.4.2" class="anchored" data-anchor-id="variance-partition-coefficient-vpc">
<span class="header-section-number">8.4.2</span> Variance Partition Coefficient (VPC)</h3>
<div class="page-columns page-full"><p>The purpose of multilevel models is to partition variance in the outcome between the different groupings in the data. We thus often want to know the percentage of variation in the dependent variable accounted by differences across groups i.e.&nbsp;what proportion of the total variance is attributable to variation within-groups, or how much is found between-groups. The statistic to obtain this is termed the variance partition coefficient (VPC), or intraclass correlation.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> For our case, the VPC at the LSOA level indicates that 14% of the variation in percentage of unemployed resident population across OAs can be explained by differences across LSOAs. What is the VPC at the MSOA level?</p><div class="no-row-height column-margin column-container"><li id="fn2"><p><sup>2</sup>&nbsp;The VPC is equal to the intra-class correlation coefficient which is the correlation between the observations of the dependent variable selected randomly from the same group. For instance, if the VPC is 0.1, we would say that 10% of the variation is between groups and 90% within. The correlation between randomly chosen pairs of observations belonging to the same group is 0.1.</p></li></div></div>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">vpc_lsoa</span> <span class="op">&lt;-</span> <span class="fl">0.0007603</span> <span class="op">/</span> <span class="op">(</span><span class="fl">0.0007603</span> <span class="op">+</span> <span class="fl">0.0020735</span> <span class="op">+</span> <span class="fl">0.0025723</span><span class="op">)</span></span>
<span><span class="va">vpc_lsoa</span> <span class="op">*</span> <span class="fl">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 14.06374</code></pre>
</div>
</div>
<p>You can also obtain the VPC by executing:</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://jtools.jacob-long.com/reference/summ.html">summ</a></span><span class="op">(</span><span class="va">model3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<table class="table table-striped table-hover table-condensed table-responsive" style="width: auto !important; margin-left: auto; margin-right: auto;"><tbody>
<tr>
<td style="text-align:left;font-weight: bold;"> Observations </td>
   <td style="text-align:right;"> 1584 </td>
  </tr>
<tr>
<td style="text-align:left;font-weight: bold;"> Dependent variable </td>
   <td style="text-align:right;"> unemp </td>
  </tr>
<tr>
<td style="text-align:left;font-weight: bold;"> Type </td>
   <td style="text-align:right;"> Mixed effects linear regression </td>
  </tr>
</tbody></table>
<table class="table table-striped table-hover table-condensed table-responsive" style="width: auto !important; margin-left: auto; margin-right: auto;"><tbody>
<tr>
<td style="text-align:left;font-weight: bold;"> AIC </td>
   <td style="text-align:right;"> -4521.26 </td>
  </tr>
<tr>
<td style="text-align:left;font-weight: bold;"> BIC </td>
   <td style="text-align:right;"> -4499.79 </td>
  </tr>
<tr>
<td style="text-align:left;font-weight: bold;"> Pseudo-R² (fixed effects) </td>
   <td style="text-align:right;"> 0.00 </td>
  </tr>
<tr>
<td style="text-align:left;font-weight: bold;"> Pseudo-R² (total) </td>
   <td style="text-align:right;"> 0.52 </td>
  </tr>
</tbody></table>
<table class="table table-striped table-hover table-condensed table-responsive" style="width: auto !important; margin-left: auto; margin-right: auto;border-bottom: 0;">
<thead>
<tr><th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="6"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">Fixed Effects</div></th></tr>
<tr>
<th style="text-align:left;">   </th>
   <th style="text-align:right;"> Est. </th>
   <th style="text-align:right;"> S.E. </th>
   <th style="text-align:right;"> t val. </th>
   <th style="text-align:right;"> d.f. </th>
   <th style="text-align:right;"> p </th>
  </tr>
</thead>
<tbody><tr>
<td style="text-align:left;font-weight: bold;"> (Intercept) </td>
   <td style="text-align:right;"> 0.12 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 18.63 </td>
   <td style="text-align:right;"> 59.98 </td>
   <td style="text-align:right;"> 0.00 </td>
  </tr></tbody>
<tfoot><tr><td style="padding: 0; " colspan="100%">
<sup></sup>  p values calculated using Kenward-Roger standard errors and d.f. </td></tr></tfoot>
</table>
<table class="table table-striped table-hover table-condensed table-responsive" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr><th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">Random Effects</div></th></tr>
<tr>
<th> Group </th>
   <th> Parameter </th>
   <th> Std. Dev. </th>
  </tr>
</thead>
<tbody>
<tr>
<td> lsoa_cd </td>
   <td> (Intercept) </td>
   <td> 0.03 </td>
  </tr>
<tr>
<td> msoa_cd </td>
   <td> (Intercept) </td>
   <td> 0.05 </td>
  </tr>
<tr>
<td> Residual </td>
   <td>  </td>
   <td> 0.05 </td>
  </tr>
</tbody>
</table>
<table class="table table-striped table-hover table-condensed table-responsive" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr><th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">Grouping Variables</div></th></tr>
<tr>
<th> Group </th>
   <th> # groups </th>
   <th> ICC </th>
  </tr>
</thead>
<tbody>
<tr>
<td> lsoa_cd </td>
   <td> 298 </td>
   <td> 0.14 </td>
  </tr>
<tr>
<td> msoa_cd </td>
   <td> 61 </td>
   <td> 0.38 </td>
  </tr>
</tbody>
</table>
</div>
</div>
</section><section id="uncertainty-of-estimates" class="level3" data-number="8.4.3"><h3 data-number="8.4.3" class="anchored" data-anchor-id="uncertainty-of-estimates">
<span class="header-section-number">8.4.3</span> Uncertainty of Estimates</h3>
<p>You may have noticed that <code>lme4</code> does not provide p-values, because of <a href="https://stat.ethz.ch/pipermail/r-help/2006-May/094765.html">various reasons</a> as explained by Doug Bates, one of the author of <code>lme4</code>. These explanations mainly refer to the complexity of dealing with varying sample sizes at a given hierarchical level. The number of observations at each hierarchical level varies across individual groupings (i.e.&nbsp;LSOA or MSOA). It may even be one single observation. This has implications for the distributional assumptions, denominator degrees of freedom and how to approximate a “best” solution. Various approaches exist to compute the statistical significance of estimates. We use the <code>confint</code> function available within <code>lme4</code> to obtain confidence intervals.</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span><span class="op">(</span><span class="va">model3</span>, level <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing profile confidence intervals ...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                 2.5 %     97.5 %
.sig01      0.02360251 0.03189046
.sig02      0.03707707 0.05562307
.sigma      0.04882281 0.05273830
(Intercept) 0.10307341 0.12751103</code></pre>
</div>
</div>
<p><code>.sig01</code> refers to the LSOA level; <code>.sig02</code> refers to the MSOA level; and, <code>.sigma</code> refers to the OA level.</p>
</section><section id="assessing-group-level-variation" class="level3" data-number="8.4.4"><h3 data-number="8.4.4" class="anchored" data-anchor-id="assessing-group-level-variation">
<span class="header-section-number">8.4.4</span> Assessing Group-level Variation</h3>
<p><em>Estimated regression coefficients</em></p>
<p>In multilevel modelling, our primary interest is in knowing differences across groups. To visualise the estimated model within each group (ie. LSOA and MSOA), we type:</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">coef_m3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">coef_m3</span><span class="op">$</span><span class="va">lsoa_cd</span>,<span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          (Intercept)
E01006512  0.09915456
E01006513  0.09889615
E01006514  0.09297051
E01006515  0.09803754
E01006518  0.09642939</code></pre>
</div>
</div>
<p>The results indicate that the estimated regression line is <span class="math inline">\(y = 0.09915456\)</span> for LSOA <code>E01006512</code>; <span class="math inline">\(y = 0.09889615\)</span> for LSOA <code>E01006513</code> and so forth. Try getting the estimated model within each MSOA.</p>
<p><em>Random effects</em></p>
<p>We can look at the estimated group-level (or LSOA-level and MSOA-level) errors; that is, <em>random effects</em>:</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ranef_m3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/random.effects.html">ranef</a></span><span class="op">(</span><span class="va">model3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">ranef_m3</span><span class="op">$</span><span class="va">lsoa_cd</span>, <span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          (Intercept)
E01006512 -0.01613353
E01006513 -0.01639194
E01006514 -0.02231758
E01006515 -0.01725055
E01006518 -0.01885870</code></pre>
</div>
</div>
<p>Group-level errors indicate how much the intercept is shifted up or down in particular groups (ie. LSOAs or MSOAs). Thus, for example, in LSOA <code>E01006512</code>, the estimated intercept is <code>-0.01613353</code> lower than average, so that the regression line is <code>(0.1152881 - 0.01613353)</code> <code>= 0.09915457</code> which is what we observed from the call to <code><a href="https://rdrr.io/r/stats/coef.html">coef()</a></code>.</p>
<p>We can also obtain group-level errors (<em>random effects</em>) by using a simulation approach, labelled “Empirical Bayes” and discussed <a href="https://stat.ethz.ch/pipermail/r-sig-mixed-models/2009q4/002984.html">here</a>. To this end, we run:</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># obtain estimates</span></span>
<span><span class="fu">merTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/merTools/man/REsim.html">REsim</a></span><span class="op">(</span><span class="va">model3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   groupFctr   groupID        term         mean       median         sd
1    lsoa_cd E01006512 (Intercept) -0.015282358 -0.014848796 0.01903544
2    lsoa_cd E01006513 (Intercept) -0.016209433 -0.015065126 0.02047753
3    lsoa_cd E01006514 (Intercept) -0.025155978 -0.024718295 0.02161466
4    lsoa_cd E01006515 (Intercept) -0.018462219 -0.019780436 0.01908881
5    lsoa_cd E01006518 (Intercept) -0.018345939 -0.020120473 0.01878457
6    lsoa_cd E01006519 (Intercept) -0.015526480 -0.014544111 0.01030805
7    lsoa_cd E01006520 (Intercept) -0.023959651 -0.023568505 0.01962450
8    lsoa_cd E01006521 (Intercept)  0.007240119  0.005636689 0.02009481
9    lsoa_cd E01006522 (Intercept)  0.018042823  0.017148770 0.01983297
10   lsoa_cd E01006523 (Intercept)  0.003177441  0.004090357 0.01880763</code></pre>
</div>
</div>
<p>The results contain the estimated mean, median and standard deviation for the intercept within each group (e.g.&nbsp;LSOA). The mean estimates are similar to those obtained from <code>ranef</code> with some small differences due to rounding.</p>
<p>To gain an undertanding of the general pattern of the <em>random effects</em>, we can use caterpillar plots via <code>plotREsim</code> - reported below. The plot on the right shows the estimated random effects for each MSOA and their respective interval estimate. Note that random effects are on average zero, represented by the red horizontal line. Intervals that do not include zero are in bold. Also note that the width of the confidence interval depends on the standard error of the respective residual estimate, which is inversely related to the size of the sample. The residuals represent an observation departures from the grand mean, so an observation whose confidence interval does not overlap the line at zero (representing the mean proportion of unemployed population across all areas) is said to differ significantly from the average at the 5% level.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/merTools/man/plotREsim.html">plotREsim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/merTools/man/REsim.html">REsim</a></span><span class="op">(</span><span class="va">model3</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07-multilevel-modelling_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Focusing on the plot on the right, we see MSOAs whose mean proportion of unemployed population, assuming no explanatory variables, is lower than average. On the right-hand side of the plot, you will see MSOAs whose mean proportion is higher than average. The MSOAs with the smallest residuals include the districts of Allerton and Hunt Cross, Church, Childwall, Wavertree and Woolton. What districts do we have at the other extreme?</p>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/merTools/man/REsim.html">REsim</a></span><span class="op">(</span><span class="va">model3</span><span class="op">)</span></span>
<span><span class="va">oa_shp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">msoa_cd</span>, <span class="va">ward_nm</span>, <span class="va">unemp</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">msoa_cd</span><span class="op">)</span> <span class="op">==</span> <span class="st">"E02001387"</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">msoa_cd</span><span class="op">)</span> <span class="op">==</span> <span class="st">"E02001393"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 49 features and 3 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 339178.6 ymin: 386244.2 xmax: 341959.9 ymax: 389646.7
Projected CRS: Transverse_Mercator
First 10 features:
     msoa_cd                  ward_nm      unemp                       geometry
1  E02001393 Allerton and Hunts Cross 0.03246753 POLYGON ((341333.6 387163.2...
2  E02001393 Allerton and Hunts Cross 0.03684211 POLYGON ((340658.2 387205.6...
3  E02001393                   Church 0.04098361 POLYGON ((339908.1 387222.3...
4  E02001393 Allerton and Hunts Cross 0.05982906 POLYGON ((340306 386587, 34...
5  E02001393                   Church 0.01212121 POLYGON ((339974.2 387118.5...
6  E02001393                   Church 0.09219858 POLYGON ((340181.4 386957.8...
7  E02001393                   Church 0.01986755 POLYGON ((340301.2 386582.2...
8  E02001393                   Church 0.04615385 POLYGON ((340375.9 386918.6...
9  E02001393 Allerton and Hunts Cross 0.04117647 POLYGON ((340435.3 386337.4...
10 E02001393 Allerton and Hunts Cross 0.02272727 POLYGON ((340681.7 386614.4...</code></pre>
</div>
</div>
<p>We can also map the MSOA-level <em>random effects</em>. To this end, we first need to read a shapefile containing data at the MSOA level and merge it with the <em>random effects</em> estimates.</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># read data</span></span>
<span><span class="va">msoa_shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/mlm/MSOA.shp"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `MSOA' from data source 
  `/Users/franciscorowe/Dropbox/Francisco/Research/sdsm_book/smds/data/mlm/MSOA.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 61 features and 17 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 333086.1 ymin: 381426.3 xmax: 345636 ymax: 397980.1
Projected CRS: Transverse_Mercator</code></pre>
</div>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create a dataframe for MSOA-level random effects</span></span>
<span><span class="va">re_msoa</span> <span class="op">&lt;-</span> <span class="va">re</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">groupFctr</span> <span class="op">==</span> <span class="st">"msoa_cd"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">re_msoa</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   61 obs. of  6 variables:
 $ groupFctr: chr  "msoa_cd" "msoa_cd" "msoa_cd" "msoa_cd" ...
 $ groupID  : chr  "E02001347" "E02001348" "E02001349" "E02001350" ...
 $ term     : chr  "(Intercept)" "(Intercept)" "(Intercept)" "(Intercept)" ...
 $ mean     : num  -0.01346 -0.0256 -0.03288 0.00458 0.02411 ...
 $ median   : num  -0.01173 -0.02132 -0.03242 0.00756 0.0232 ...
 $ sd       : num  0.0327 0.0338 0.0303 0.0322 0.0167 ...</code></pre>
</div>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># merge data</span></span>
<span><span class="va">msoa_shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/merge.html">merge</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">msoa_shp</span>, y <span class="op">=</span> <span class="va">re_msoa</span>, by.x <span class="op">=</span> <span class="st">"MSOA_CD"</span>, by.y <span class="op">=</span> <span class="st">"groupID"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can create our map:</p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># ensure geometry is valid</span></span>
<span><span class="va">msoa_shp</span> <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html">st_make_valid</a></span><span class="op">(</span><span class="va">msoa_shp</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a map</span></span>
<span><span class="va">legend_title</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="st">"MSOA-level residuals"</span><span class="op">)</span></span>
<span><span class="va">map_msoa</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">msoa_shp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_fill</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"mean"</span>, title <span class="op">=</span> <span class="va">legend_title</span>, palette <span class="op">=</span> <span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html">magma</a></span><span class="op">(</span><span class="fl">256</span>, begin <span class="op">=</span> <span class="fl">0</span>, end <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, style <span class="op">=</span> <span class="st">"cont"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_borders</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"white"</span>, lwd <span class="op">=</span> <span class="fl">.01</span><span class="op">)</span>  <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_compass.html">tm_compass</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"arrow"</span>, position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"right"</span>, <span class="st">"top"</span><span class="op">)</span> , size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_scale_bar.html">tm_scale_bar</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, text.size <span class="op">=</span> <span class="fl">0.5</span>, position <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"center"</span>, <span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">map_msoa</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07-multilevel-modelling_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="sec-indlevel" class="level3" data-number="8.4.5"><h3 data-number="8.4.5" class="anchored" data-anchor-id="sec-indlevel">
<span class="header-section-number">8.4.5</span> Adding Individual-level Predictors</h3>
<p>In this example, <span class="math inline">\(\mu\)</span> represents the sample mean but it could include a collection of independent variables or predictors. To explain the logic, we will assume that unemployment is strongly associated to long-term illness. We could expect that long-term illness (<code>lt_ill</code>) will reduce the chances of working and therefore being unemployed. Note that our focus is on the relationship, not on establishing causation. Specifically we want to estimate the relationship between unemployment and long-term illness and we are interested in variations in OA-level unemployment by MSOAs so we will estimate the following two-level model:</p>
<p>OA-level:</p>
<p><span class="math display">\[y_{ij} = \beta_{0j} + \beta_{1}x_{ij} + e_{ij}\]</span> MSOA-level:</p>
<p><span class="math display">\[\beta_{0j} = \beta_{0} + u_{0j}\]</span> Replacing the first equation into the second, we have:</p>
<p><span class="math display">\[y_{ij} = (\beta_{0} + u_{0j}) + \beta_{1}x_{ij} + e_{ij}\]</span> where <span class="math inline">\(y\)</span> the proportion of unemployed population in OA <span class="math inline">\(i\)</span> within MSOA <span class="math inline">\(j\)</span>; <span class="math inline">\(\beta_{0}\)</span> is the fixed intercept (averaging over all MSOAs); <span class="math inline">\(u_{0j}\)</span> represents the MSOA-level residuals or <em>random effects</em>; <span class="math inline">\(\beta_{0}\)</span> and <span class="math inline">\(u_{0j}\)</span> together represent the varying-intercept; <span class="math inline">\(\beta_{1}\)</span> is the slope coefficient; <span class="math inline">\(x_{ij}\)</span> represents the percentage of long-term illness population; and, <span class="math inline">\(e_{ij}\)</span> is the individual-level residuals.</p>
<p>We estimate the model executing:</p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># change to proportion</span></span>
<span><span class="va">oa_shp</span><span class="op">$</span><span class="va">lt_ill</span> <span class="op">&lt;-</span> <span class="va">lt_ill</span><span class="op">/</span><span class="fl">100</span></span>
<span></span>
<span><span class="co"># specify a model equation</span></span>
<span><span class="va">eq4</span> <span class="op">&lt;-</span> <span class="va">unemp</span> <span class="op">~</span> <span class="va">lt_ill</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">msoa_cd</span><span class="op">)</span></span>
<span><span class="va">model4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">eq4</span>, data <span class="op">=</span> <span class="va">oa_shp</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># estimates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: unemp ~ lt_ill + (1 | msoa_cd)
   Data: oa_shp

REML criterion at convergence: -4711.9

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-5.1941 -0.5718 -0.0906  0.4507  5.9393 

Random effects:
 Groups   Name        Variance Std.Dev.
 msoa_cd  (Intercept) 0.001421 0.03769 
 Residual             0.002674 0.05171 
Number of obs: 1584, groups:  msoa_cd, 61

Fixed effects:
            Estimate Std. Error t value
(Intercept)  0.04682    0.00625   7.492
lt_ill       0.29588    0.01615  18.317

Correlation of Fixed Effects:
       (Intr)
lt_ill -0.600</code></pre>
</div>
</div>
<p><em>Fixed effects</em>: model averaging over MSOAs</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/fixed.effects.html">fixef</a></span><span class="op">(</span><span class="va">model4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)      lt_ill 
 0.04681959  0.29588110 </code></pre>
</div>
</div>
<p>yields an estimated regression line in an average McSOA: <span class="math inline">\(y = 0.04681959 + 0.29588110x\)</span></p>
<p><em>Random effects</em>: MSOA-level errors</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ranef_m4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/random.effects.html">ranef</a></span><span class="op">(</span><span class="va">model4</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">ranef_m4</span><span class="op">$</span><span class="va">msoa_cd</span>, <span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           (Intercept)
E02001347 -0.017474815
E02001348 -0.021203807
E02001349 -0.022469313
E02001350 -0.003539869
E02001351  0.008502813</code></pre>
</div>
</div>
<p>yields an estimated intercept for MSOA <code>E02001347</code> which is <code>0.017474815</code> lower than the average with a regression line: <code>(0.04681959 - 0.017474815) + 0.29588110x</code> <code>=</code> <code>0.02934478 + 0.29588110x</code>. You can confirm this by looking at the estimated model within each MSOA by executing (remove the <code>#</code> sign):</p>
<div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#coef(model4)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>Fixed effect correlations</em></p>
<p>In the bottom of the output, we have the correlations between the fixed-effects estimates. In our example, it refers to the correlation between <span class="math inline">\(\beta_{0}\)</span> and <span class="math inline">\(\beta_{1}\)</span>. It is negative indicating that in MSOAs where the relationship between unemployment and long-term illness is greater, as measured by <span class="math inline">\(\beta_{1}\)</span>, the average proportion of unemployed people tends to be smaller, as captured by <span class="math inline">\(\beta_{0}\)</span>.</p>
</section><section id="sec-grouplevel" class="level3" data-number="8.4.6"><h3 data-number="8.4.6" class="anchored" data-anchor-id="sec-grouplevel">
<span class="header-section-number">8.4.6</span> Adding Group-level Predictors</h3>
<p>We can also add group-level predictors. We use the formulation:</p>
<p>OA-level:</p>
<p><span class="math display">\[y_{ij} = \beta_{0j} + \beta_{1}x_{ij} + e_{ij}\]</span></p>
<p>MSOA-level:</p>
<p><span class="math display">\[\beta_{0j} = \beta_{0} + \gamma_{1}m_{j} + u_{0j}\]</span></p>
<p>where <span class="math inline">\(x_{ij}\)</span> is the OA-level proportion of population suffering long-term illness and <span class="math inline">\(m_{j}\)</span> is the MSOA-level proportion of male population. We first need to create this group-level predictor:</p>
<div class="cell">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># detach OA shp and attach MSOA shp</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/detach.html">detach</a></span><span class="op">(</span><span class="va">oa_shp</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/attach.html">attach</a></span><span class="op">(</span><span class="va">msoa_shp</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from package:viridis:

    unemp</code></pre>
</div>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># group-level predictor</span></span>
<span><span class="va">msoa_shp</span><span class="op">$</span><span class="va">pr_male</span> <span class="op">&lt;-</span> <span class="va">males</span><span class="op">/</span><span class="va">pop</span></span>
<span></span>
<span><span class="co"># remove geometries</span></span>
<span><span class="va">msoa_df</span> <span class="op">&lt;-</span> <span class="fu">`st_geometry&lt;-`</span><span class="op">(</span><span class="va">msoa_shp</span>, <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># select variables</span></span>
<span><span class="va">msoa_df</span> <span class="op">&lt;-</span> <span class="va">msoa_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">MSOA_CD</span>, <span class="va">pop</span>, <span class="va">pr_male</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># merge data sets</span></span>
<span><span class="va">oa_shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/merge.html">merge</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">oa_shp</span>, y<span class="op">=</span><span class="va">msoa_df</span>, by.x <span class="op">=</span> <span class="st">"msoa_cd"</span>, by.y<span class="op">=</span><span class="st">"MSOA_CD"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># inspect data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">oa_shp</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"msoa_cd"</span>, <span class="st">"oa_cd"</span>, <span class="st">"unemp"</span>, <span class="st">"pr_male"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 4 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 337693.5 ymin: 396068.2 xmax: 339430.9 ymax: 397790
Projected CRS: Transverse_Mercator
    msoa_cd     oa_cd      unemp   pr_male                       geometry
1 E02001347 E00033730 0.10322581 0.4775905 POLYGON ((338376 397059, 33...
2 E02001347 E00033722 0.06306306 0.4775905 POLYGON ((337929.4 397669.9...
3 E02001347 E00033712 0.09090909 0.4775905 POLYGON ((338830 396068.2, ...
4 E02001347 E00033739 0.09401709 0.4775905 POLYGON ((339140.3 397191, ...
5 E02001347 E00033719 0.05855856 0.4775905 POLYGON ((338128.8 397658.6...
6 E02001347 E00033711 0.12195122 0.4775905 POLYGON ((339163.2 396833.6...</code></pre>
</div>
</div>
<p>We can now estimate our model:</p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/detach.html">detach</a></span><span class="op">(</span><span class="va">msoa_shp</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/attach.html">attach</a></span><span class="op">(</span><span class="va">oa_shp</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from package:viridis:

    unemp</code></pre>
</div>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># specify a model equation</span></span>
<span><span class="va">eq5</span> <span class="op">&lt;-</span> <span class="va">unemp</span> <span class="op">~</span> <span class="va">lt_ill</span> <span class="op">+</span> <span class="va">pr_male</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">msoa_cd</span><span class="op">)</span></span>
<span><span class="va">model5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">eq5</span>, data <span class="op">=</span> <span class="va">oa_shp</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># estimates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: unemp ~ lt_ill + pr_male + (1 | msoa_cd)
   Data: oa_shp

REML criterion at convergence: -4712.3

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-5.2162 -0.5696 -0.0929  0.4549  5.9370 

Random effects:
 Groups   Name        Variance Std.Dev.
 msoa_cd  (Intercept) 0.001391 0.03729 
 Residual             0.002674 0.05171 
Number of obs: 1584, groups:  msoa_cd, 61

Fixed effects:
            Estimate Std. Error t value
(Intercept) -0.07746    0.08768  -0.883
lt_ill       0.29781    0.01620  18.389
pr_male      0.25059    0.17642   1.420

Correlation of Fixed Effects:
        (Intr) lt_ill
lt_ill  -0.118       
pr_male -0.997  0.075</code></pre>
</div>
</div>
<p>This model includes the proportion of males and intercepts that vary by MSOA. The <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer()</a></code> function only accepts predictors at the individual level, so we have included data on the proportion of male population at this level. Explore and interpret the model running the functions below:</p>
<div class="cell">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># fixed effects</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/fixed.effects.html">fixef</a></span><span class="op">(</span><span class="va">model5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)      lt_ill     pr_male 
 -0.0774607   0.2978084   0.2505913 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># random effects</span></span>
<span><span class="va">ranef_m5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/random.effects.html">ranef</a></span><span class="op">(</span><span class="va">model5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">ranef_m5</span><span class="op">$</span><span class="va">msoa_cd</span>, <span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           (Intercept)
E02001347 -0.013625261
E02001348 -0.019757846
E02001349 -0.023709992
E02001350  0.003003861
E02001351  0.003508477</code></pre>
</div>
</div>
<p>Adding group-level predictors tends to improve inferences for group coefficients. Examine the confidence intervals, in order to evalute how the precision of our estimates of the MSOA intercepts have changed. <em>Have confidence intervals for the intercepts of Model 4 and 5 increased or reduced?</em> Hint: look at how to get the confidence intervals above.</p>
</section></section><section id="questions" class="level2" data-number="8.5"><h2 data-number="8.5" class="anchored" data-anchor-id="questions">
<span class="header-section-number">8.5</span> Questions</h2>
<p>For the second assignment, we will be using a different dataset comprising information on COVID-19 cases, census data and the Index of Multiple Deprivation (IMD) for England. The data set is similar in structured to that used in this chapter. It is hierarchically organised into 149 Upper Tier Local Authority Districts (UTLADs) within 9 Regions and has 508 variables - see Chapter @ref(datasets) for a more detailed description of the data.</p>
<div class="cell">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/assignment_2_covid/covid19_eng.gpkg"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `covid19_eng' from data source 
  `/Users/franciscorowe/Dropbox/Francisco/Research/sdsm_book/smds/data/assignment_2_covid/covid19_eng.gpkg' 
  using driver `GPKG'
Simple feature collection with 149 features and 507 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 134112.4 ymin: 11429.67 xmax: 655653.8 ymax: 657536
Projected CRS: OSGB36 / British National Grid</code></pre>
</div>
</div>
<p>Here we see a selection of 10 variables for 5 UTLADs.</p>
<div class="cell">
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">sdf</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">9</span>,<span class="fl">10</span>,<span class="fl">381</span>,<span class="fl">385</span>,<span class="fl">386</span>,<span class="fl">387</span>,<span class="fl">403</span>,<span class="fl">406</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 5 features and 10 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 418871.2 ymin: 506329.3 xmax: 478441.5 ymax: 537152
Projected CRS: OSGB36 / British National Grid
             ctyua19nm     Region X2020.01.31 X2020.02.01 IMD...Average.score
1           Hartlepool North East           0           0              35.037
2        Middlesbrough North East           0           0              40.460
3 Redcar and Cleveland North East           0           0              29.792
4     Stockton-on-Tees North East           0           0              25.790
5           Darlington North East           0           0              25.657
  Residents Households Dwellings Age_85plus White_British_and_Irish
1     92028      40434     42102       1856                   89117
2    138412      57203     59956       2465                  119680
3    135177      59605     61899       3113                  132343
4    191610      79159     82237       3481                  179501
5    105564      46670     48644       2550                   99226
                            geom
1 MULTIPOLYGON (((447097 5371...
2 MULTIPOLYGON (((449862.8 52...
3 MULTIPOLYGON (((455939.7 52...
4 MULTIPOLYGON (((444126.1 52...
5 MULTIPOLYGON (((423475.7 52...</code></pre>
</div>
</div>
<ul>
<li>
<code>ctyua19nm</code>: Upper Tier Local Authority District name</li>
<li>
<code>Region</code>: Region name</li>
<li>
<code>X2020.01.31</code>: COVID-19 cases on January 31st 2020</li>
<li>
<code>X2020.02.01</code>: COVID-19 cases on February 1st 2020</li>
<li>
<code>IMD...Average.score</code>: Average IMD score for UTLADs - see <a href="https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019">File 11: upper-tier local authority summaries</a> for information on this and associated indicators.</li>
<li>
<code>Residents</code>: Number of residents</li>
<li>
<code>Households</code>: Number of households</li>
<li>
<code>Dwellings</code>: Number of dwellings</li>
<li>
<code>Age_85plus</code>: Number of people aged 85 and over</li>
<li>
<code>White_British_and_Irish</code>: Number of white British and Irish people</li>
</ul>
<p>Note that variable names relating to the daily COVID-19 cases are organised in the following way: <code>X</code> stands for daily COVID-19 cases, followed by the year (i.e.&nbsp;2020, 2021); month (i.e.&nbsp;January to December); and day (i.e.&nbsp;01 to 31).</p>
<p>Using these data, you are required to address the following challenges:</p>
<ol type="1">
<li><p>Fit a varying-intercept model with no explanatory variables. Let the intercept to vary by region.</p></li>
<li><p>Fit a varying-intercept model with including at least three explanatory variables.</p></li>
<li><p>Compute the Variance Partition Coefficient (VPC) for the models estimated according to points 1 and 2 above.</p></li>
<li><p>Create caterpillar plots to visualise the varying intercepts.</p></li>
</ol>
<p>Analyse and discuss: 1. the extent of variation in the dependent variables at the two geographical scales (variation at which geographical scale explains most of variance in your dependent variable); 2. the varying intercept estimate(s) from your model(s) (what can they tell you about the difference between groups / areas? are they statistically significantly different?);</p>
<p>Ensure you appropriately describe the structure of the data and identify the various geographical scales of analysis (i.e.&nbsp;level-1 and level-2 units)</p>
<p>In addressing the challenges in this and following chapters, you have some flexibility to be creative. A set of key factors to consider:</p>
<ol type="1">
<li>
<em>Dependent Variable</em>: We will seek to explain daily COVID-19 cases, and you will need to make a decision as to:</li>
</ol>
<ul>
<li><p><em>Daily vs cumulative COVID-19 cases</em>. Given that we will be focusing on cross-sectional models (i.e.&nbsp;models for one snapshot), you can focus on modelling daily cases at one specific date or cumulative daily cases over a period of time.</p></li>
<li><p><em>Time period</em>. You can select the date or period of time that you will focus your analysis on.</p></li>
<li><p><em>Use risk of COVID-19 infection</em>. The dependent variable should be the risk or rate of COVID-19 infection.</p></li>
</ul>
<p>For example, the risk of COVID-19 infection for the period (i.e.&nbsp;between Dec.&nbsp;1st, 2020 - January 29th, 2021) comprising the third wave of the pandemic in the United Kingdom can be computed as:</p>
<div class="cell">
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># computing cumulative COVID cases for  01/12/2020 - 29/01/2021</span></span>
<span><span class="va">sdf</span><span class="op">[</span>, <span class="fl">509</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sdf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"X2020.12.01"</span><span class="op">:</span><span class="st">"X2021.01.29"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># select COVID cases 01/12/2020 - 29/01/2021</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cum_covid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">rowSums</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># sum daily cases</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">cum_covid</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># select cumulative cases</span></span>
<span>   <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_set_geometry</a></span><span class="op">(</span><span class="va">.</span>, <span class="cn">NULL</span><span class="op">)</span> <span class="co"># set geometry to NULL</span></span>
<span></span>
<span><span class="co"># computing risk of infection</span></span>
<span><span class="va">sdf</span> <span class="op">&lt;-</span> <span class="va">sdf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>  covid19_r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">cum_covid</span> <span class="op">/</span> <span class="va">Residents</span> <span class="op">)</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span> </span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>
<em>Explanatory variables</em>:</li>
</ol>
<ul>
<li><p><em>At least 3</em>. Use at least 3 explanatory variables. There is no maximum limit but consider your model to be parsimonious.</p></li>
<li><p><em>Choice your set</em>. Select the set of variables you consider appropriate / interesting. Make sure you justify your choice based on evidence and/or theory.</p></li>
<li><p><em>Percentages / Proportions</em>. Use percentages or proportions to capture the composition of places, rather than numbers of people, households or dwellings. For this, ensure you are using the appropriate denominator.</p></li>
</ul>
<p>For instance, if you want to capture the relationship between cumulative COVID-19 cases and overcrowding, share of elderly population and nonwhite minorities, use the following variables</p>
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sdf</span> <span class="op">&lt;-</span> <span class="va">sdf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>  crowded_hou <span class="op">=</span> <span class="va">Crowded_housing</span> <span class="op">/</span> <span class="va">Households</span>, <span class="co"># share of crowded housing</span></span>
<span>  elderly <span class="op">=</span> <span class="op">(</span><span class="va">Age_85plus</span><span class="op">)</span> <span class="op">/</span> <span class="va">Residents</span>, <span class="co"># share of population aged 65+</span></span>
<span>  ethnic <span class="op">=</span> <span class="op">(</span><span class="va">Mixed</span> <span class="op">+</span> <span class="va">Indian</span> <span class="op">+</span> <span class="va">Pakistani</span> <span class="op">+</span> <span class="va">Bangladeshi</span> <span class="op">+</span> <span class="va">Chinese</span> <span class="op">+</span> <span class="va">Other_Asian</span> <span class="op">+</span> <span class="va">Black</span> <span class="op">+</span> <span class="va">Other_ethnicity</span><span class="op">)</span> <span class="op">/</span> <span class="va">Residents</span>, <span class="co"># share of nonwhite population</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>ADVICE</strong>: Create a new spatial data frame including only the variables you will analyse. For example:</p>
<div class="cell">
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nsdf</span> <span class="op">&lt;-</span> <span class="va">sdf</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">objectid</span>, </span>
<span>                         <span class="va">ctyua19cd</span>, </span>
<span>                         <span class="va">ctyua19nm</span>, </span>
<span>                         <span class="va">Region</span>, </span>
<span>                         <span class="va">covid19_r</span>, </span>
<span>                         <span class="va">crowded_hou</span>, </span>
<span>                         <span class="va">elderly</span>, </span>
<span>                         <span class="va">ethnic</span>, </span>
<span>                         <span class="va">Residents</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This chapter explains varying slopes and draws on the following references:</p>
<p>The content of this chapter is based on:</p>
<ul>
<li><p><span class="citation" data-cites="gelman2006data">Gelman and Hill (<a href="references.html#ref-gelman2006data" role="doc-biblioref">2006</a>)</span> provides an excellent and intuitive explanation of multilevel modelling and data analysis in general. Read Part 2A for a really good explanation of multilevel models.</p></li>
<li><p><span class="citation" data-cites="bristol2020">Multilevel Modelling (<a href="references.html#ref-bristol2020" role="doc-biblioref">n.d.</a>)</span> is an useful online resource on multilevel modelling and is free!</p></li>
</ul></section><section id="dependencies-1" class="level2" data-number="8.6"><h2 data-number="8.6" class="anchored" data-anchor-id="dependencies-1">
<span class="header-section-number">8.6</span> Dependencies</h2>
<p>This chapter uses the following libraries which are listed in the <span class="quarto-unresolved-ref">?sec-dependencies</span> in Chapter 1:</p>
<div class="cell">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Data manipulation, transformation and visualisation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co"># Nice tables</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span></span>
<span><span class="co"># Simple features (a standardised way to encode vector data ie. points, lines, polygons)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span> </span>
<span><span class="co"># Spatial objects conversion</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/sp/">sp</a></span><span class="op">)</span> </span>
<span><span class="co"># Thematic maps</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-tmap/tmap">tmap</a></span><span class="op">)</span> </span>
<span><span class="co"># Colour palettes</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span> </span>
<span><span class="co"># More colour palettes</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/">viridis</a></span><span class="op">)</span> <span class="co"># nice colour schemes</span></span>
<span><span class="co"># Fitting multilevel models</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="co"># Tools for extracting information generated by lme4</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">merTools</span><span class="op">)</span></span>
<span><span class="co"># Exportable regression tables</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jtools.jacob-long.com">jtools</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">stargazer</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://strengejacke.github.io/sjPlot/">sjPlot</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="data-1" class="level2 page-columns page-full" data-number="8.7"><h2 data-number="8.7" class="anchored" data-anchor-id="data-1">
<span class="header-section-number">8.7</span> Data</h2>
<div class="page-columns page-full"><p>For this chapter, we will data for Liverpool from England’s 2011 Census. The original source is the <a href="https://www.nomisweb.co.uk/home/census2001.asp">Office of National Statistics</a> and the dataset comprises a number of selected variables capturing demographic, health and socio-economic of the local resident population at four geographic levels: Output Area (OA), Lower Super Output Area (LSOA), Middle Super Output Area (MSOA) and Local Authority District (LAD). The variables include population counts and percentages. For a description of the variables, see the readme file in the mlm data folder.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p><div class="no-row-height column-margin column-container"><li id="fn3"><p><sup>3</sup>&nbsp;Read the file in R by executing <code>read_tsv("data/mlm/readme.txt")</code> . Ensure the library <code>readr</code> is installed before running <code>read_tsv</code>.</p></li></div></div>
<p>Let us read the data:</p>
<div class="cell">
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># clean workspace</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># read data</span></span>
<span><span class="va">oa_shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/mlm/OA.shp"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="conceptual-overview" class="level2" data-number="8.8"><h2 data-number="8.8" class="anchored" data-anchor-id="conceptual-overview">
<span class="header-section-number">8.8</span> Conceptual Overview</h2>
<p>So far, we have estimated varying-intercept models; that is, when the intercept (<span class="math inline">\(\beta_{0}\)</span>) is allowed to vary by group (eg. geographical area) - as shown in Fig. 1(a). The strength of the relationship between <span class="math inline">\(y\)</span> (i.e.&nbsp;unemployment rate) and <span class="math inline">\(x\)</span> (long-term illness) has been assumed to be the same across groups (i.e.&nbsp;MSOAs), as captured by the regression slope (<span class="math inline">\(\beta_{1}\)</span>). Yet it can also vary by group as shown in Fig. 1(b), or we can observe group variability for both intercepts and slopes as represented in Fig. 1(c).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="figs/ch6/fig11.1_Gelman_Hill.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Fig. 1. Linear regression model with (a) varying intercepts, (b) varying slopes, and (c) both. Source: <span class="citation" data-cites="gelman2006data">Gelman and Hill (<a href="references.html#ref-gelman2006data" role="doc-biblioref">2006</a>)</span> p.238.</figcaption><p></p>
</figure>
</div>
<section id="exploratory-analysis-varying-slopes" class="level3" data-number="8.8.1"><h3 data-number="8.8.1" class="anchored" data-anchor-id="exploratory-analysis-varying-slopes">
<span class="header-section-number">8.8.1</span> Exploratory Analysis: Varying Slopes</h3>
<p>Let’s then explore if there is variation in the relationship between unemployment rate and the share of population in long-term illness. We do this by selecting the 8 MSOAs containing OAs with the highest unemployment rates in Liverpool.</p>
<div class="cell">
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Sort data </span></span>
<span><span class="va">oa_shp</span> <span class="op">&lt;-</span> <span class="va">oa_shp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">unemp</span><span class="op">)</span></span>
<span><span class="va">oa_shp</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">9</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"msoa_cd"</span>, <span class="st">"unemp"</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 9 features and 2 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 335032 ymin: 387777 xmax: 338576.1 ymax: 395022.4
Projected CRS: Transverse_Mercator
    msoa_cd     unemp                       geometry
1 E02001354 0.5000000 MULTIPOLYGON (((337491.2 39...
2 E02001369 0.4960630 MULTIPOLYGON (((335272.3 39...
3 E02001366 0.4461538 MULTIPOLYGON (((338198.1 39...
4 E02001365 0.4352941 MULTIPOLYGON (((336572.2 39...
5 E02001370 0.4024390 MULTIPOLYGON (((336328.3 39...
6 E02001390 0.3801653 MULTIPOLYGON (((335833.6 38...
7 E02001354 0.3750000 MULTIPOLYGON (((337403 3949...
8 E02001385 0.3707865 MULTIPOLYGON (((336251.6 38...
9 E02001368 0.3648649 MULTIPOLYGON (((335209.3 39...</code></pre>
</div>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Select MSOAs</span></span>
<span><span class="va">s_t8</span> <span class="op">&lt;-</span> <span class="va">oa_shp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">msoa_cd</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"E02001354"</span>, </span>
<span>      <span class="st">"E02001369"</span>, </span>
<span>      <span class="st">"E02001366"</span>, </span>
<span>      <span class="st">"E02001365"</span>, </span>
<span>      <span class="st">"E02001370"</span>, </span>
<span>      <span class="st">"E02001390"</span>, </span>
<span>      <span class="st">"E02001368"</span>, </span>
<span>      <span class="st">"E02001385"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And then we generate a set of scatter plots and draw regression lines for each MSOA.</p>
<div class="cell">
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">s_t8</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">lt_ill</span>, y <span class="op">=</span> <span class="va">unemp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">msoa_cd</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Unemployment rate"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Long-term Illness (%)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<p><img src="07-multilevel-modelling_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can observe great variability in the relationship between unemployment rates and the percentage of population in long-term illness. A strong and positive relationship exists in MSOA <code>E02001366</code> (Tuebrook and Stoneycroft), while it is negative in MSOA <code>E02001370</code> (Everton) and neutral in MSOA <code>E02001390</code> (Princes Park &amp; Riverside). This visual inspection suggests that accounting for differences in the way unmployment rates relate to long-term illness is important. Contextual factors may differ across MSOAs in systematic ways.</p>
</section></section><section id="estimating-varying-intercept-and-slopes-models" class="level2" data-number="8.9"><h2 data-number="8.9" class="anchored" data-anchor-id="estimating-varying-intercept-and-slopes-models">
<span class="header-section-number">8.9</span> Estimating Varying Intercept and Slopes Models</h2>
<p>A way to capture for these group differences in the relationship between unemployment rates and long-term illness is to allow the relevant slope to vary by group (i.e.&nbsp;MSOA). We can do this estimating the following model:</p>
<p>OA-level:</p>
<p><span class="math display">\[y_{ij} = \beta_{0j} + \beta_{1j}x_{ij} + e_{ij}\]</span></p>
<p>MSOA-level:</p>
<p><span class="math display">\[\beta_{0j} = \beta_{0} + u_{0j}\]</span> <span class="math display">\[\beta_{1j} = \beta_{1} + u_{1j} \]</span> Replacing the first equation into the second generates:</p>
<p><span class="math display">\[y_{ij} = (\beta_{0} + u_{0j}) + (\beta_{1} + u_{1j})x_{ij} + e_{ij}\]</span> where, as in the previous Chapter, <span class="math inline">\(y\)</span> the proportion of unemployed population in OA <span class="math inline">\(i\)</span> within MSOA <span class="math inline">\(j\)</span>; <span class="math inline">\(\beta_{0}\)</span> is the fixed intercept (averaging over all MSOAs); <span class="math inline">\(u_{0j}\)</span> represents the MSOA-level residuals, or <em>random effects</em>, of the intercept; <span class="math inline">\(e_{ij}\)</span> is the individual-level residuals; and, <span class="math inline">\(x_{ij}\)</span> represents the percentage of long-term illness population. <em>But</em> now we have a varying slope represented by <span class="math inline">\(\beta_{1}\)</span> and <span class="math inline">\(u_{1j}\)</span>: <span class="math inline">\(\beta_{1}\)</span> is estimated average slope - fixed part of the model; and, <span class="math inline">\(u_{1j}\)</span> is the estimated group-level errors of the slope.</p>
<p>To estimate such model, we add <code>lt_ill</code> in the bracket with a <code>+</code> sign between <code>1</code> and <code>|</code> i.e.&nbsp;<code>(1 + lt_ill | msoa_cd)</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># attach df</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/attach.html">attach</a></span><span class="op">(</span><span class="va">oa_shp</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># change to proportion</span></span>
<span><span class="va">oa_shp</span><span class="op">$</span><span class="va">lt_ill</span> <span class="op">&lt;-</span> <span class="va">lt_ill</span><span class="op">/</span><span class="fl">100</span></span>
<span></span>
<span><span class="co"># specify a model equation</span></span>
<span><span class="va">eq6</span> <span class="op">&lt;-</span> <span class="va">unemp</span> <span class="op">~</span> <span class="va">lt_ill</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">lt_ill</span> <span class="op">|</span> <span class="va">msoa_cd</span><span class="op">)</span></span>
<span><span class="va">model6</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">eq6</span>, data <span class="op">=</span> <span class="va">oa_shp</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># estimates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model6</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: unemp ~ lt_ill + (1 + lt_ill | msoa_cd)
   Data: oa_shp

REML criterion at convergence: -4762.8

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-3.6639 -0.5744 -0.0873  0.4565  5.4876 

Random effects:
 Groups   Name        Variance Std.Dev. Corr 
 msoa_cd  (Intercept) 0.003428 0.05855       
          lt_ill      0.029425 0.17154  -0.73
 Residual             0.002474 0.04974       
Number of obs: 1584, groups:  msoa_cd, 61

Fixed effects:
            Estimate Std. Error t value
(Intercept) 0.047650   0.008635   5.519
lt_ill      0.301259   0.028162  10.697

Correlation of Fixed Effects:
       (Intr)
lt_ill -0.786</code></pre>
</div>
</div>
<p>In this model, the estimated standard deviation of the unexplained within-MSOA variation is 0.04974, and the estimated standard deviation of the MSOA intercepts is 0.05855. But, additionally, we also have estimates of standard deviation of the MSOA slopes (0.17154) and correlation between MSOA-level residuals for the intercept and slope (-0.73). While the former measures the extent of average deviation in the slopes across MSOAs, the latter indicates that the intercept and slope MSOA-level residuals are negatively associated; that is, MSOAs with large slopes have relatively smaller intercepts and <em>vice versa</em>. We will come back to this in Section <a href="#interpreting-correlations-between-group-level-intercepts-and-slopes">Interpreting Correlations Between Group-level Intercepts and Slopes</a>.</p>
<p>Similarly, the correlation of fixed effects indicates a negative relationship between the intercept and slope of the average regression model; that is, as the average model intercept tends to increase, the average strength of the relationship between unemployment rate and long-term illness decreases and <em>vice versa</em>.</p>
<p>We then explore the estimated average coefficients (<em>fixed effects</em>):</p>
<div class="cell">
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/fixed.effects.html">fixef</a></span><span class="op">(</span><span class="va">model6</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)      lt_ill 
 0.04765009  0.30125875 </code></pre>
</div>
</div>
<p>yields an estimated regression line in an average LSOA: <span class="math inline">\(y = 0.04764998 + 0.30125916x\)</span>. The fixed intercept indicates that the average unemployment rate is 0.05 if the percentage of population with long-term illness is zero.The fixed slope indicates that the average relationship between unemployment rate and long-term illness is positive across MSOAs i.e.&nbsp;as the percentage of population with long-term illness increases by 1 percentage point, the unemployment rate increases by 0.3.</p>
<p>We look the estimated MSOA-level errors (<em>random effects</em>):</p>
<div class="cell">
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ranef_m6</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/random.effects.html">ranef</a></span><span class="op">(</span><span class="va">model6</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">ranef_m6</span><span class="op">$</span><span class="va">msoa_cd</span>, <span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           (Intercept)      lt_ill
E02001347 -0.026561345  0.02718102
E02001348  0.001688245 -0.11533102
E02001349 -0.036084817  0.05547075
E02001350  0.032240842 -0.14298734
E02001351  0.086214137 -0.28130162</code></pre>
</div>
</div>
<p>Recall these estimates indicate the extent of deviation of the MSOA-specific intercept and slope from the estimated model average captured by the fixed model component.</p>
<p>We can also regain the estimated intercept and slope for each county by adding the estimated MSOA-level errors to the estimated average coefficients; or by executing:</p>
<div class="cell">
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#coef(model6)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We are normally more interested in identifying the extent of deviation and its significance. To this end, we create a caterpillar plot:</p>
<div class="cell">
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/merTools/man/plotREsim.html">plotREsim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/merTools/man/REsim.html">REsim</a></span><span class="op">(</span><span class="va">model6</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07-multilevel-modelling_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>These plots reveal some interesting patterns. First, only one MSOA, containing wards such as Tuebrook and Stoneycroft, Anfield &amp; Everton, seems to have a statistically significantly different intercept, or average unemployment rate. Confidence intervals overlap zero for all other 60 MSOAs. Despite this, note that when a slope is allowed to vary by group, it generally makes sense for the intercept to also vary. Second, significant variability exists in the association between unemployment rate and long-term illness across MSOAs. Ten MSOAs display a significant positive association, while 12 exhibit a significantly negative relationship. Third, these results reveal that geographical differences in the relationship between unemployment rate and long-term illness can explain the significant differences in average unemployment rates in the varying intercept only model.</p>
<p>Let’s try to get a better understanding of the varying relationship between unemployment rate and long-term illness by mapping the relevant MSOA-level errors.</p>
<div class="cell">
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># read data</span></span>
<span><span class="va">msoa_shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/mlm/MSOA.shp"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `MSOA' from data source 
  `/Users/franciscorowe/Dropbox/Francisco/Research/sdsm_book/smds/data/mlm/MSOA.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 61 features and 17 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 333086.1 ymin: 381426.3 xmax: 345636 ymax: 397980.1
Projected CRS: Transverse_Mercator</code></pre>
</div>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create a dataframe for MSOA-level random effects</span></span>
<span><span class="va">re_msoa_m6</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/merTools/man/REsim.html">REsim</a></span><span class="op">(</span><span class="va">model6</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">groupFctr</span> <span class="op">==</span> <span class="st">"msoa_cd"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"lt_ill"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">re_msoa_m6</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   61 obs. of  6 variables:
 $ groupFctr: chr  "msoa_cd" "msoa_cd" "msoa_cd" "msoa_cd" ...
 $ groupID  : chr  "E02001347" "E02001348" "E02001349" "E02001350" ...
 $ term     : chr  "lt_ill" "lt_ill" "lt_ill" "lt_ill" ...
 $ mean     : num  0.0217 -0.1152 0.054 -0.143 -0.2845 ...
 $ median   : num  0.0192 -0.1183 0.0686 -0.1399 -0.2835 ...
 $ sd       : num  0.0438 0.0774 0.0857 0.0374 0.0342 ...</code></pre>
</div>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># merge data</span></span>
<span><span class="va">msoa_shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/merge.html">merge</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">msoa_shp</span>, y <span class="op">=</span> <span class="va">re_msoa_m6</span>, by.x <span class="op">=</span> <span class="st">"MSOA_CD"</span>, by.y <span class="op">=</span> <span class="st">"groupID"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># ensure geometry is valid</span></span>
<span><span class="va">msoa_shp</span> <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html">st_make_valid</a></span><span class="op">(</span><span class="va">msoa_shp</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a map</span></span>
<span><span class="va">legend_title</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="st">"MSOA-level residuals"</span><span class="op">)</span></span>
<span><span class="va">map_msoa</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">msoa_shp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_fill</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"median"</span>, title <span class="op">=</span> <span class="va">legend_title</span>, palette <span class="op">=</span> <span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html">magma</a></span><span class="op">(</span><span class="fl">256</span>, begin <span class="op">=</span> <span class="fl">0</span>, end <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, style <span class="op">=</span> <span class="st">"cont"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_borders</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"white"</span>, lwd <span class="op">=</span> <span class="fl">.01</span><span class="op">)</span>  <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_compass.html">tm_compass</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"arrow"</span>, position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"right"</span>, <span class="st">"top"</span><span class="op">)</span> , size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_scale_bar.html">tm_scale_bar</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, text.size <span class="op">=</span> <span class="fl">0.5</span>, position <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"center"</span>, <span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">map_msoa</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07-multilevel-modelling_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The map indicates that the relationship between unemployment rate and long-term illness is tends to stronger and positive in northern MSOAs; that is, the percentage of population with long-term illness explains a greater share of the variation in unemployment rates in these locations. As expected, a greater share of population in long-term illness is associated with higher local unemployment. In contrast, the relationship between unemployment rate and long-term illness tends to operate in the reverse direction in north-east and middle-southern MSOAs. In these MSOAs, OAs tend to have a higher unemployment rate relative the share of population in long-term illness. You can confirm this examining the data for specific MSOA executing:</p>
<div class="cell">
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">oa_shp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">msoa_cd</span>, <span class="va">ward_nm</span>, <span class="va">unemp</span>, <span class="va">lt_ill</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">msoa_cd</span><span class="op">)</span> <span class="op">==</span> <span class="st">"E02001370"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 23 features and 4 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 335885 ymin: 391134.2 xmax: 337596.3 ymax: 392467
Projected CRS: Transverse_Mercator
First 10 features:
     msoa_cd                  ward_nm     unemp    lt_ill
1  E02001370                  Everton 0.4024390 0.2792793
2  E02001370 Tuebrook and Stoneycroft 0.3561644 0.3391813
3  E02001370                  Everton 0.3285714 0.3106383
4  E02001370                  Everton 0.3209877 0.3283019
5  E02001370                  Anfield 0.3082707 0.1785714
6  E02001370                  Everton 0.3000000 0.4369501
7  E02001370                  Everton 0.2886598 0.3657143
8  E02001370                  Everton 0.2727273 0.3375000
9  E02001370                  Everton 0.2705882 0.2534247
10 E02001370 Tuebrook and Stoneycroft 0.2661290 0.2941176
                         geometry
1  MULTIPOLYGON (((336328.3 39...
2  MULTIPOLYGON (((337481.5 39...
3  MULTIPOLYGON (((336018.5 39...
4  MULTIPOLYGON (((336475.7 39...
5  MULTIPOLYGON (((337110.6 39...
6  MULTIPOLYGON (((336516.3 39...
7  MULTIPOLYGON (((336668.6 39...
8  MULTIPOLYGON (((336173.8 39...
9  MULTIPOLYGON (((336870 3917...
10 MULTIPOLYGON (((337363.8 39...</code></pre>
</div>
</div>
<p>Now try adding a group-level predictor and an individual-level predictor to the model. Unsure, look at <a href="#sec-indlevel"><span>Section&nbsp;8.4.5</span></a> and <a href="#sec-grouplevel"><span>Section&nbsp;8.4.6</span></a> in <span class="quarto-unresolved-ref">?sec-chp7</span>.</p>
</section><section id="interpreting-correlations-between-group-level-intercepts-and-slopes" class="level2" data-number="8.10"><h2 data-number="8.10" class="anchored" data-anchor-id="interpreting-correlations-between-group-level-intercepts-and-slopes">
<span class="header-section-number">8.10</span> Interpreting Correlations Between Group-level Intercepts and Slopes</h2>
<p>Correlations of random effects are confusing to interpret. Key for their appropriate interpretation is to recall they refer to group-level residuals i.e.&nbsp;deviation of intercepts and slopes from the average model intercept and slope. A strong <em>negative</em> correlation indicates that groups with high intercepts have relatively low slopes, and <em>vice versa</em>. A strong <em>positive</em> correlation indicates that groups with high intercepts have relatively high slopes, and <em>vice versa</em>. A correlation close to <em>zero</em> indicate little or no systematic between intercepts and slopes. Note that a high correlation between intercepts and slopes is not a problem, but it makes the interpretation of the estimated intercepts more challenging. For this reason, a suggestion is to center predictors (<span class="math inline">\(x's\)</span>); that is, substract their average value (<span class="math inline">\(z = x - \bar{x}\)</span>). For a more detailed discussion, see <span class="citation" data-cites="bristol2020">Multilevel Modelling (<a href="references.html#ref-bristol2020" role="doc-biblioref">n.d.</a>)</span>.</p>
<p>To illustrate this, let’s reestimate our model adding an individual-level predictor: the share of population with no educational qualification.</p>
<div class="cell">
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># centering to the mean</span></span>
<span><span class="va">oa_shp</span><span class="op">$</span><span class="va">z_no_qual</span> <span class="op">&lt;-</span> <span class="va">no_qual</span><span class="op">/</span><span class="fl">100</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">no_qual</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">oa_shp</span><span class="op">$</span><span class="va">z_lt_ill</span> <span class="op">&lt;-</span> <span class="va">lt_ill</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">lt_ill</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># specify a model equation</span></span>
<span><span class="va">eq7</span> <span class="op">&lt;-</span> <span class="va">unemp</span> <span class="op">~</span> <span class="va">z_lt_ill</span> <span class="op">+</span> <span class="va">z_no_qual</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">z_lt_ill</span> <span class="op">|</span> <span class="va">msoa_cd</span><span class="op">)</span></span>
<span><span class="va">model7</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">eq7</span>, data <span class="op">=</span> <span class="va">oa_shp</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># estimates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model7</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: unemp ~ z_lt_ill + z_no_qual + (1 + z_lt_ill | msoa_cd)
   Data: oa_shp

REML criterion at convergence: -4940.7

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-3.6830 -0.5949 -0.0868  0.4631  6.3556 

Random effects:
 Groups   Name        Variance  Std.Dev. Corr 
 msoa_cd  (Intercept) 8.200e-04 0.02864       
          z_lt_ill    2.161e-06 0.00147  -0.04
 Residual             2.246e-03 0.04739       
Number of obs: 1584, groups:  msoa_cd, 61

Fixed effects:
              Estimate Std. Error t value
(Intercept)  0.1163682  0.0039201   29.68
z_lt_ill    -0.0003130  0.0003404   -0.92
z_no_qual    0.3245811  0.0221347   14.66

Correlation of Fixed Effects:
          (Intr) z_lt_l
z_lt_ill  -0.007       
z_no_qual -0.015 -0.679</code></pre>
</div>
</div>
<p>How do you interpret the random effect correlation?</p>
</section><section id="model-building" class="level2" data-number="8.11"><h2 data-number="8.11" class="anchored" data-anchor-id="model-building">
<span class="header-section-number">8.11</span> Model building</h2>
<p>Now we know how to estimate multilevel regression models in <em>R</em>. The question that remains is: <em>When does multilevel modeling make a difference?</em> The short answer is: when there is little group-level variation. When there is very little group-level variation, the multilevel modelling reduces to classical linear regression estimates <em>with no group indicators</em>. Inversely, when group-level coefficients vary greatly (compared to their standard errors of estimation), multilevel modelling reduces to classical regression <em>with group indicators</em> <span class="citation" data-cites="gelman2006data">Gelman and Hill (<a href="references.html#ref-gelman2006data" role="doc-biblioref">2006</a>)</span>.</p>
<p><em>How do you go about building a model?</em></p>
<p>We generally start simple by fitting simple linear regressions and then work our way up to a full multilevel model - see <span class="citation" data-cites="gelman2006data">Gelman and Hill (<a href="references.html#ref-gelman2006data" role="doc-biblioref">2006</a>)</span> p.&nbsp;270.</p>
<p><em>How many groups are needed?</em></p>
<p>As an absolute minimum, more than two groups are required. With only one or two groups, a multilevel model reduces to a linear regression model.</p>
<p><em>How many observations per group?</em></p>
<p>Two observations per group is sufficient to fit a multilevel model.</p>
<section id="model-comparison" class="level3" data-number="8.11.1"><h3 data-number="8.11.1" class="anchored" data-anchor-id="model-comparison">
<span class="header-section-number">8.11.1</span> Model Comparison</h3>
<p><em>How we assess different candidate models?</em> We can use the function <code><a href="https://rdrr.io/r/stats/anova.html">anova()</a></code> and assess various statistics: The Akaike Information Criterion (AIC), the Bayesian Information Criterion (BIC), Loglik and Deviance. Generally, we look for lower scores for all these indicators. We can also refer to the <em>Chisq</em> statistic below. It tests the hypothesis of whether additional predictors improve model fit. Particularly it tests the <em>Null Hypothesis</em> whether the coefficients of the additional predictors equal 0. It does so comparing the deviance statistic and determining if changes in the deviance are statistically significant. Note that a major limitation of the deviance test is that it is for nested models i.e.&nbsp;a model being compared must be nested in the other. Below we compare our two models. The results indicate that adding an individual-level predictor (i.e.&nbsp;the share of population with no qualification) provides a model with better.</p>
<div class="cell">
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/anova.html">anova</a></span><span class="op">(</span><span class="va">model6</span>, <span class="va">model7</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>refitting model(s) with ML (instead of REML)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Data: oa_shp
Models:
model6: unemp ~ lt_ill + (1 + lt_ill | msoa_cd)
model7: unemp ~ z_lt_ill + z_no_qual + (1 + z_lt_ill | msoa_cd)
       npar     AIC     BIC logLik deviance  Chisq Df Pr(&gt;Chisq)    
model6    6 -4764.7 -4732.5 2388.3  -4776.7                         
model7    7 -4956.5 -4918.9 2485.2  -4970.5 193.76  1  &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
</section></section><section id="questions-1" class="level2" data-number="8.12"><h2 data-number="8.12" class="anchored" data-anchor-id="questions-1">
<span class="header-section-number">8.12</span> Questions</h2>
<p>We will continue to use the COVID-19 dataset. Please see <span class="quarto-unresolved-ref">?sec-chp11</span> for details on the data.</p>
<div class="cell">
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/assignment_2_covid/covid19_eng.gpkg"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `covid19_eng' from data source 
  `/Users/franciscorowe/Dropbox/Francisco/Research/sdsm_book/smds/data/assignment_2_covid/covid19_eng.gpkg' 
  using driver `GPKG'
Simple feature collection with 149 features and 507 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 134112.4 ymin: 11429.67 xmax: 655653.8 ymax: 657536
Projected CRS: OSGB36 / British National Grid</code></pre>
</div>
</div>
<p>Using these data, you are required to address the following challenges:</p>
<ol type="1">
<li><p>Fit a varying-slope model. Let one slope to vary by region. Think carefully your choice.</p></li>
<li><p>Fit a varying-intercept and varying-slope model.</p></li>
<li><p>Compare the results for models fitted in 1 and 2. Which is better? Why?</p></li>
</ol>
<p>Use the same explanatory variables used for the <span class="quarto-unresolved-ref">?sec-chp7</span> challenge, so you can compare the model results from this chapter.</p>
<p>Analyse and discuss:</p>
<ol type="1">
<li>the varying slope estimate(s) from your model(s) (to what extent does the relationship between your dependent and independent variables vary across groups / areas? are they statistically significantly different?).</li>
<li>differences between your varying intercept and varying slope models.</li>
</ol>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-gelman2006data" class="csl-entry" role="doc-biblioentry">
Gelman, Andrew, and Jennifer Hill. 2006. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge University Press.
</div>
<div id="ref-bristol2020" class="csl-entry" role="doc-biblioentry">
Multilevel Modelling, Centre for. n.d. <span>“Introduction to Multilevel Modelling.”</span> n.d. <a href="http://www.bristol.ac.uk/cmm/learning/online-course/course-topics.html#m04">http://www.bristol.ac.uk/cmm/learning/online-course/course-topics.html#m04</a>.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./06-spatial-heterogeneity.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Spatial heterogeneity</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./08-weighted-regression-modelling.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Geographically weighted regression modelling</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb106" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Multilevel modelling</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>This chapter provides an introduction to multi-level data structures and multi-level modelling and draws on the following references:</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>@gelman2006data provides an excellent and intuitive explanation of multilevel modelling and data analysis in general. Read Part 2A for a really good explanation of multilevel models.</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>@bristol2020 is an useful online resource on multilevel modelling and is free!</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a><span class="fu">## Dependencies</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>This chapter uses the following libraries which are listed in the <span class="sc">\[</span>Dependency list<span class="sc">\]</span> Section of Chapter 1:</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message = FALSE}</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Data manipulation, transformation and visualisation</span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Nice tables</span></span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple features (a standardised way to encode vector data ie. points, lines, polygons)</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf) </span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial objects conversion</span></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sp) </span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Thematic maps</span></span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap) </span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Colour palettes</span></span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer) </span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a><span class="co"># More colour palettes</span></span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis) <span class="co"># nice colour schemes</span></span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting multilevel models</span></span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Tools for extracting information generated by lme4</span></span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(merTools)</span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Exportable regression tables</span></span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jtools)</span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stargazer)</span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sjPlot)</span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-36"><a href="#cb106-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-37"><a href="#cb106-37" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data</span></span>
<span id="cb106-38"><a href="#cb106-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-39"><a href="#cb106-39" aria-hidden="true" tabindex="-1"></a>For this chapter, we will data for Liverpool from England's 2011 Census. The original source is the <span class="co">[</span><span class="ot">Office of National Statistics</span><span class="co">](https://www.nomisweb.co.uk/home/census2001.asp)</span> and the dataset comprises a number of selected variables capturing demographic, health and socio-economic attributes of the local resident population at four geographic levels: Output Area (OA), Lower Super Output Area (LSOA), Middle Super Output Area (MSOA) and Local Authority District (LAD). The variables include population counts and percentages. For a description of the variables, see the readme file in the mlm data folder.<span class="ot">[^07-multilevel-01-1]</span></span>
<span id="cb106-40"><a href="#cb106-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-41"><a href="#cb106-41" aria-hidden="true" tabindex="-1"></a><span class="ot">[^07-multilevel-01-1]: </span>Read the file in R by executing <span class="in">`read_tsv("data/mlm/readme.txt")`</span> . Ensure the library <span class="in">`readr`</span> is installed before running <span class="in">`read_tsv`</span>.</span>
<span id="cb106-42"><a href="#cb106-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-43"><a href="#cb106-43" aria-hidden="true" tabindex="-1"></a>Let us read the data:</span>
<span id="cb106-44"><a href="#cb106-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-45"><a href="#cb106-45" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, results = 'hide'}</span></span>
<span id="cb106-46"><a href="#cb106-46" aria-hidden="true" tabindex="-1"></a><span class="co"># clean workspace</span></span>
<span id="cb106-47"><a href="#cb106-47" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb106-48"><a href="#cb106-48" aria-hidden="true" tabindex="-1"></a><span class="co"># read data</span></span>
<span id="cb106-49"><a href="#cb106-49" aria-hidden="true" tabindex="-1"></a>oa_shp <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/mlm/OA.shp"</span>)</span>
<span id="cb106-50"><a href="#cb106-50" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-51"><a href="#cb106-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-52"><a href="#cb106-52" aria-hidden="true" tabindex="-1"></a>We can now attach and visualise the structure of the data.</span>
<span id="cb106-53"><a href="#cb106-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-56"><a href="#cb106-56" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-57"><a href="#cb106-57" aria-hidden="true" tabindex="-1"></a><span class="co"># attach data frame</span></span>
<span id="cb106-58"><a href="#cb106-58" aria-hidden="true" tabindex="-1"></a><span class="fu">attach</span>(oa_shp)</span>
<span id="cb106-59"><a href="#cb106-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-60"><a href="#cb106-60" aria-hidden="true" tabindex="-1"></a><span class="co"># sort data by oa</span></span>
<span id="cb106-61"><a href="#cb106-61" aria-hidden="true" tabindex="-1"></a>oa_shp <span class="ot">&lt;-</span> oa_shp[<span class="fu">order</span>(oa_cd),]</span>
<span id="cb106-62"><a href="#cb106-62" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(oa_shp)</span>
<span id="cb106-63"><a href="#cb106-63" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-64"><a href="#cb106-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-65"><a href="#cb106-65" aria-hidden="true" tabindex="-1"></a><span class="al">![Fig. 1. Data Structure.](figs/ch5/datastr.png)</span></span>
<span id="cb106-66"><a href="#cb106-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-67"><a href="#cb106-67" aria-hidden="true" tabindex="-1"></a>The data are hierarchically structured: OAs nested within LSOAs; LSOAs nested within MSOAs; and, MSOAs nested within LADs. Observations nested within higher geographical units may be correlated.</span>
<span id="cb106-68"><a href="#cb106-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-69"><a href="#cb106-69" aria-hidden="true" tabindex="-1"></a>This is one type of hierarchical structure. There is a range of data structures:</span>
<span id="cb106-70"><a href="#cb106-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-71"><a href="#cb106-71" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Strict nested data structures eg. an individual unit is nested within only one higher unit</span>
<span id="cb106-72"><a href="#cb106-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-73"><a href="#cb106-73" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Repeated measures structures eg. various measurements for an individual unit</span>
<span id="cb106-74"><a href="#cb106-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-75"><a href="#cb106-75" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Crossed classified structures eg. individuals may work and live in different neighbourhoods</span>
<span id="cb106-76"><a href="#cb106-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-77"><a href="#cb106-77" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Multiple membership structure eg. individuals may have two different work places</span>
<span id="cb106-78"><a href="#cb106-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-79"><a href="#cb106-79" aria-hidden="true" tabindex="-1"></a>*Why should we care about the structure of the data?*</span>
<span id="cb106-80"><a href="#cb106-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-81"><a href="#cb106-81" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Draw correct statistical inference*: Failing to recognise hierarchical structures will lead to underestimated standard errors of regression coefficients and an overstatement of statistical significance. Standard errors for the coefficients of higher-level predictor variables will be the most affected by ignoring grouping.</span>
<span id="cb106-82"><a href="#cb106-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-83"><a href="#cb106-83" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Link context to individual units*: We can link and understand the extent of group effects on individual outcomes eg. how belonging to a certain socio-economic group influences on future career opportunities.</span>
<span id="cb106-84"><a href="#cb106-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-85"><a href="#cb106-85" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Spatial dependency*: Recognising the hierarchical structure of data may help mitigate the effects of severe spatial autocorrelation.</span>
<span id="cb106-86"><a href="#cb106-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-87"><a href="#cb106-87" aria-hidden="true" tabindex="-1"></a>Quickly, let us get a better idea about the data and look at the number of OAs nested within LSOAs and MSOAs</span>
<span id="cb106-88"><a href="#cb106-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-91"><a href="#cb106-91" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-92"><a href="#cb106-92" aria-hidden="true" tabindex="-1"></a><span class="co"># mean of nested OAs within LSOAs and MSOAs</span></span>
<span id="cb106-93"><a href="#cb106-93" aria-hidden="true" tabindex="-1"></a>lsoa_cd <span class="sc">%&gt;%</span> <span class="fu">table</span>() <span class="sc">%&gt;%</span></span>
<span id="cb106-94"><a href="#cb106-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>() <span class="sc">%&gt;%</span></span>
<span id="cb106-95"><a href="#cb106-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(, <span class="dv">2</span>)</span>
<span id="cb106-96"><a href="#cb106-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-97"><a href="#cb106-97" aria-hidden="true" tabindex="-1"></a>msoa_cd <span class="sc">%&gt;%</span> <span class="fu">table</span>() <span class="sc">%&gt;%</span></span>
<span id="cb106-98"><a href="#cb106-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>() <span class="sc">%&gt;%</span></span>
<span id="cb106-99"><a href="#cb106-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(, <span class="dv">2</span>)</span>
<span id="cb106-100"><a href="#cb106-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-101"><a href="#cb106-101" aria-hidden="true" tabindex="-1"></a><span class="co"># number of OAs nested within LSOAs and MSOAs</span></span>
<span id="cb106-102"><a href="#cb106-102" aria-hidden="true" tabindex="-1"></a>lsoa_cd <span class="sc">%&gt;%</span> <span class="fu">table</span>() <span class="sc">%&gt;%</span></span>
<span id="cb106-103"><a href="#cb106-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sort</span>() <span class="sc">%&gt;%</span></span>
<span id="cb106-104"><a href="#cb106-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span>
<span id="cb106-105"><a href="#cb106-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-106"><a href="#cb106-106" aria-hidden="true" tabindex="-1"></a>msoa_cd <span class="sc">%&gt;%</span> <span class="fu">table</span>() <span class="sc">%&gt;%</span></span>
<span id="cb106-107"><a href="#cb106-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sort</span>() <span class="sc">%&gt;%</span></span>
<span id="cb106-108"><a href="#cb106-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span>
<span id="cb106-109"><a href="#cb106-109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-110"><a href="#cb106-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-111"><a href="#cb106-111" aria-hidden="true" tabindex="-1"></a><span class="fu">## Modelling</span></span>
<span id="cb106-112"><a href="#cb106-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-113"><a href="#cb106-113" aria-hidden="true" tabindex="-1"></a>We should now be persuaded that ignoring the hierarchical structure of data may be a major issue. Let us now use a simple example to understand the intuition of multilevel model using the census data. We will seek to understand the spatial distribution of the proportion of population in unemployment in Liverpool, particularly why and where concentrations in this proportion occur. To illustrate the advantages of taking a multilevel modelling approach, we will start by estimating a linear regression model and progressively building complexity. We will first estimate a model and then explain the intuition underpinning the process. We will seek to gain a general understanding of multilevel modelling. If you are interested in the statistical and mathemathical formalisation of the underpinning concepts, please refer to @gelman2006data.</span>
<span id="cb106-114"><a href="#cb106-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-115"><a href="#cb106-115" aria-hidden="true" tabindex="-1"></a>We first need to want to understand our dependent variable: its density ditribution;</span>
<span id="cb106-116"><a href="#cb106-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-119"><a href="#cb106-119" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-120"><a href="#cb106-120" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> oa_shp) <span class="sc">+</span></span>
<span id="cb106-121"><a href="#cb106-121" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_density</span>(<span class="at">alpha=</span><span class="fl">0.8</span>, <span class="at">colour=</span><span class="st">"black"</span>, <span class="at">fill=</span><span class="st">"lightblue"</span>, <span class="fu">aes</span>(<span class="at">x =</span> unemp)) <span class="sc">+</span></span>
<span id="cb106-122"><a href="#cb106-122" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme_classic</span>()</span>
<span id="cb106-123"><a href="#cb106-123" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-124"><a href="#cb106-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-127"><a href="#cb106-127" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-128"><a href="#cb106-128" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(unemp)</span>
<span id="cb106-129"><a href="#cb106-129" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-130"><a href="#cb106-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-131"><a href="#cb106-131" aria-hidden="true" tabindex="-1"></a>and, its spatial distribution:</span>
<span id="cb106-132"><a href="#cb106-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-135"><a href="#cb106-135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-136"><a href="#cb106-136" aria-hidden="true" tabindex="-1"></a><span class="co"># ensure geometry is valid</span></span>
<span id="cb106-137"><a href="#cb106-137" aria-hidden="true" tabindex="-1"></a>oa_shp <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_make_valid</span>(oa_shp)</span>
<span id="cb106-138"><a href="#cb106-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-139"><a href="#cb106-139" aria-hidden="true" tabindex="-1"></a><span class="co"># create a map</span></span>
<span id="cb106-140"><a href="#cb106-140" aria-hidden="true" tabindex="-1"></a>legend_title <span class="ot">=</span> <span class="fu">expression</span>(<span class="st">"% unemployment"</span>)</span>
<span id="cb106-141"><a href="#cb106-141" aria-hidden="true" tabindex="-1"></a>map_oa <span class="ot">=</span> <span class="fu">tm_shape</span>(oa_shp) <span class="sc">+</span></span>
<span id="cb106-142"><a href="#cb106-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="at">col =</span> <span class="st">"unemp"</span>, <span class="at">title =</span> legend_title, <span class="at">palette =</span> <span class="fu">magma</span>(<span class="dv">256</span>, <span class="at">begin =</span> <span class="fl">0.25</span>, <span class="at">end =</span> <span class="dv">1</span>), <span class="at">style =</span> <span class="st">"cont"</span>) <span class="sc">+</span> </span>
<span id="cb106-143"><a href="#cb106-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> .<span class="dv">01</span>)  <span class="sc">+</span> </span>
<span id="cb106-144"><a href="#cb106-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_compass</span>(<span class="at">type =</span> <span class="st">"arrow"</span>, <span class="at">position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"top"</span>) , <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span> </span>
<span id="cb106-145"><a href="#cb106-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_scale_bar</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">text.size =</span> <span class="fl">0.5</span>, <span class="at">position =</span>  <span class="fu">c</span>(<span class="st">"center"</span>, <span class="st">"bottom"</span>)) </span>
<span id="cb106-146"><a href="#cb106-146" aria-hidden="true" tabindex="-1"></a>map_oa</span>
<span id="cb106-147"><a href="#cb106-147" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-148"><a href="#cb106-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-149"><a href="#cb106-149" aria-hidden="true" tabindex="-1"></a>Let us look at those areas:</span>
<span id="cb106-150"><a href="#cb106-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-153"><a href="#cb106-153" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-154"><a href="#cb106-154" aria-hidden="true" tabindex="-1"></a><span class="co"># high %s</span></span>
<span id="cb106-155"><a href="#cb106-155" aria-hidden="true" tabindex="-1"></a>oa_shp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(unemp <span class="sc">&gt;</span> <span class="fl">0.2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb106-156"><a href="#cb106-156" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(oa_cd, pop, unemp) </span>
<span id="cb106-157"><a href="#cb106-157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-158"><a href="#cb106-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-159"><a href="#cb106-159" aria-hidden="true" tabindex="-1"></a><span class="fu">### Baseline Linear Regression Model</span></span>
<span id="cb106-160"><a href="#cb106-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-161"><a href="#cb106-161" aria-hidden="true" tabindex="-1"></a>Now let us estimate a simple linear regression model with the intercept only:</span>
<span id="cb106-162"><a href="#cb106-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-165"><a href="#cb106-165" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-166"><a href="#cb106-166" aria-hidden="true" tabindex="-1"></a><span class="co"># specify a model equation</span></span>
<span id="cb106-167"><a href="#cb106-167" aria-hidden="true" tabindex="-1"></a>eq1 <span class="ot">&lt;-</span> unemp <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb106-168"><a href="#cb106-168" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="at">formula =</span> eq1, <span class="at">data =</span> oa_shp)</span>
<span id="cb106-169"><a href="#cb106-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-170"><a href="#cb106-170" aria-hidden="true" tabindex="-1"></a><span class="co"># estimates</span></span>
<span id="cb106-171"><a href="#cb106-171" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model1)</span>
<span id="cb106-172"><a href="#cb106-172" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-173"><a href="#cb106-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-174"><a href="#cb106-174" aria-hidden="true" tabindex="-1"></a>To understand the differences between the linear regression model and multilevel models, let us consider the model we have estimated:</span>
<span id="cb106-175"><a href="#cb106-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-176"><a href="#cb106-176" aria-hidden="true" tabindex="-1"></a>$$y_{i} = \beta_{0} + e_{i}$$ where $y_{i}$ represents the proportion of the unemployed resident population in the OA $i$; $\beta_{0}$ is the regression intercept and measures the average proportion of the unemployed resident population across OAs; and, $e_{i}$ is the error term. But how do we deal with the hierarchical structure of the data?</span>
<span id="cb106-177"><a href="#cb106-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-178"><a href="#cb106-178" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Limitations</span></span>
<span id="cb106-179"><a href="#cb106-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-180"><a href="#cb106-180" aria-hidden="true" tabindex="-1"></a>Before looking at the answer, let's first understand some of the key limitations of the linear regression model to handle the hierarchical structure of data. A key limitation of the linear regression model is that it only captures average relationships in the data. It does not capture variations in the relationship between variables across areas or groups. Another key limitation is that the linear regression model can capture associations at either macro or micro levels, but it does not simultaneously measure their interdependencies.</span>
<span id="cb106-181"><a href="#cb106-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-182"><a href="#cb106-182" aria-hidden="true" tabindex="-1"></a>To illustrate this, let us consider the regression intercept. It indicates that the average percentage of unemployed population at the OA level is 0.12 but this model ignores any spatial clustering ie. the percentage of unemployed population tends to be similar across OAs nested within a same LSOA or MSOA. A side effect of ignoring this is that our standard errors are biased, and thus claims about statistical significance based on them would be misleading. Additionally, this situation also means we cannot explore variations in the percentage of unemployed population across LSOAs or MSOAs ie. how the percentage of unemployed population may be dependent on various contextual factors at these geographical scales.</span>
<span id="cb106-183"><a href="#cb106-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-184"><a href="#cb106-184" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fixed Effect Approach</span></span>
<span id="cb106-185"><a href="#cb106-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-186"><a href="#cb106-186" aria-hidden="true" tabindex="-1"></a>An alternative approach is to adopt a fixed effects approach, or no-pooling model; that is, adding dummy variables indicating the group classification into the regression model eg. the way OAs is nested within LSOAs (or MSOAs). This approach has limitations. First, there is high risk of overfitting. The number of groups may be too large, relative to the number of observations. Second, the estimation of multiple parameters may be required so that measuring differences between groups may be challenging. Third, a fixed effects approach does not allow including group-level explanatory variables. You can try fitting a linear regression model extending our estimated model to include dummy variables for individual LSOAs (and/or MSOAs) so you can compare this to the multilevel model below.</span>
<span id="cb106-187"><a href="#cb106-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-188"><a href="#cb106-188" aria-hidden="true" tabindex="-1"></a>An alternative is fitting separate linear regression models for each group. This approach is not always possible if there are groups with small sizes.</span>
<span id="cb106-189"><a href="#cb106-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-190"><a href="#cb106-190" aria-hidden="true" tabindex="-1"></a><span class="fu">## Multilevel Modelling: Random Intercept Model</span></span>
<span id="cb106-191"><a href="#cb106-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-192"><a href="#cb106-192" aria-hidden="true" tabindex="-1"></a>We use multilevel modelling to account for the hierarchical nature of the data by explicitly recognising that OAs are nested within LSOAs and MSOAs. Multilevel models can easily be estimated using in R using the package <span class="in">`lme4`</span>. We implement an two-level model to allow for variation across LSOAs. We estimate an only intercept model allowing for variation across LSOAs. In essence, we are estimating a model with varying intercept coefficient by LSOA. As you can see in the code chunk below, the equation has an additional component. This is the group component or LSOA effect. The <span class="in">`(1 | lsoa_cd)`</span> means that we are allowing the intercept, represented by 1, to vary by LSOA.</span>
<span id="cb106-193"><a href="#cb106-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-196"><a href="#cb106-196" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-197"><a href="#cb106-197" aria-hidden="true" tabindex="-1"></a><span class="co"># specify a model equation</span></span>
<span id="cb106-198"><a href="#cb106-198" aria-hidden="true" tabindex="-1"></a>eq2 <span class="ot">&lt;-</span> unemp <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> lsoa_cd)</span>
<span id="cb106-199"><a href="#cb106-199" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(eq2, <span class="at">data =</span> oa_shp)</span>
<span id="cb106-200"><a href="#cb106-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-201"><a href="#cb106-201" aria-hidden="true" tabindex="-1"></a><span class="co"># estimates</span></span>
<span id="cb106-202"><a href="#cb106-202" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model2)</span>
<span id="cb106-203"><a href="#cb106-203" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-204"><a href="#cb106-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-205"><a href="#cb106-205" aria-hidden="true" tabindex="-1"></a>We can estimate a three-level model by adding <span class="in">`(1 | msoa_cd)`</span> to allow the intercept to also vary by MSOAs and account for the nesting structure of LSOAs within MSOAs.</span>
<span id="cb106-206"><a href="#cb106-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-209"><a href="#cb106-209" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-210"><a href="#cb106-210" aria-hidden="true" tabindex="-1"></a><span class="co"># specify a model equation</span></span>
<span id="cb106-211"><a href="#cb106-211" aria-hidden="true" tabindex="-1"></a>eq3 <span class="ot">&lt;-</span> unemp <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> lsoa_cd) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> msoa_cd)</span>
<span id="cb106-212"><a href="#cb106-212" aria-hidden="true" tabindex="-1"></a>model3 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(eq3, <span class="at">data =</span> oa_shp)</span>
<span id="cb106-213"><a href="#cb106-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-214"><a href="#cb106-214" aria-hidden="true" tabindex="-1"></a><span class="co"># estimates</span></span>
<span id="cb106-215"><a href="#cb106-215" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model3)</span>
<span id="cb106-216"><a href="#cb106-216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-217"><a href="#cb106-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-218"><a href="#cb106-218" aria-hidden="true" tabindex="-1"></a>We see two sets of coefficients: *fixed effects* and *random effects*. *Fixed effects* correspond to the standard linear regression coefficients. Their interpretation is as usual. *Random effects* are the novelty. It is a term in multilevel modelling and refers to varying coefficients i.e. the randomness in the probability of the model for the group-level coefficients. Specifically they relate to estimates of the average variance and standard deviation within groups (i.e. LSOAs or MSOAs). Intiutively, variance and standard deviation indicate the extent to which the intercept, on average, varies by LSOAs and MSOAs.</span>
<span id="cb106-219"><a href="#cb106-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-220"><a href="#cb106-220" aria-hidden="true" tabindex="-1"></a><span class="al">![Fig. 2. Variation of observations around their level 1 group mean.](figs/ch5/nm_dist_obs.png)</span></span>
<span id="cb106-221"><a href="#cb106-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-222"><a href="#cb106-222" aria-hidden="true" tabindex="-1"></a><span class="al">![Fig. 3. Variation of level 1 group mean around their level 2 group mean.](figs/ch5/nm_dist_msoa.png)</span></span>
<span id="cb106-223"><a href="#cb106-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-224"><a href="#cb106-224" aria-hidden="true" tabindex="-1"></a><span class="al">![Fig. 4. Grand mean.](figs/ch5/nm_dist_grand.png)</span></span>
<span id="cb106-225"><a href="#cb106-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-226"><a href="#cb106-226" aria-hidden="true" tabindex="-1"></a>More formally, we first estimated the simplest regression model which is an intercept-only model and equivalent to the sample mean (i.e. the *fixed* part of the model):</span>
<span id="cb106-227"><a href="#cb106-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-228"><a href="#cb106-228" aria-hidden="true" tabindex="-1"></a>$$y_{ijk} = \mu + e_{ijk}$$ and then we made the *random* part of the model ($e_{ijk}$) more complex to account for the hierarchical structure of the data by estimating the following three-level regression model:</span>
<span id="cb106-229"><a href="#cb106-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-230"><a href="#cb106-230" aria-hidden="true" tabindex="-1"></a>$$y_{ijk} = \mu + u_{i..} + u_{ij.} + e_{ijk}$$</span>
<span id="cb106-231"><a href="#cb106-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-232"><a href="#cb106-232" aria-hidden="true" tabindex="-1"></a>where $y_{ijk}$ represents the proportion of unemployed population in OA $i$ nested within LSOA $j$ and MSOA $k$; $\mu$ represents the sample mean and the *fixed* part of the model; $e_{ijk}$ is the deviation of an observation from its LSOA mean; $u_{ij.}$ is the deviation of the LSOA mean from its MSOA mean; $u_{i..}$ is the deviation of the MSOA mean from the fixed part of the model $\mu$. Conceptually, this model is decomposing the variance of the model in terms of the hierarchical structure of the data. It is partitioning the observation's residual into three parts or *variance components*. These components measure the relative extent of variation of each hierarchical level ie. LSOA, MSOA and grand means. To estimate the set of residuals, they are assumed to follow a normal distribution and are obtained after fitting the model and are based on the estimates of the model parameters (i.e. intercept and variances of the random parameters).</span>
<span id="cb106-233"><a href="#cb106-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-234"><a href="#cb106-234" aria-hidden="true" tabindex="-1"></a>Let's now return to our three-level model (reported again below), we see that the intercept or fixed part of the model is the same as for the linear regression. The multilevel model reports greater standard errors. Multilevel models capture the hierarchical structure of the data and thus more precisely estimate the standard errors for our parameters.</span>
<span id="cb106-235"><a href="#cb106-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-238"><a href="#cb106-238" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-239"><a href="#cb106-239" aria-hidden="true" tabindex="-1"></a><span class="co"># report model 3</span></span>
<span id="cb106-240"><a href="#cb106-240" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model3)</span>
<span id="cb106-241"><a href="#cb106-241" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-242"><a href="#cb106-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-243"><a href="#cb106-243" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpretation</span></span>
<span id="cb106-244"><a href="#cb106-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-245"><a href="#cb106-245" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Fixed effects</span></span>
<span id="cb106-246"><a href="#cb106-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-247"><a href="#cb106-247" aria-hidden="true" tabindex="-1"></a>We start by examining the fixed effects or estimated model averaging over LSOAs and MSOAs, $y_{ijk} = 0.115288$ which can also be called by executing:</span>
<span id="cb106-248"><a href="#cb106-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-251"><a href="#cb106-251" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-252"><a href="#cb106-252" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(model3)</span>
<span id="cb106-253"><a href="#cb106-253" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-254"><a href="#cb106-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-255"><a href="#cb106-255" aria-hidden="true" tabindex="-1"></a>Th estimated intercept indicates that the overall mean taken across LSOAs and MSOAs is estimated as <span class="in">`0.115288`</span> and is statistically significant at <span class="in">`5%`</span> significance.</span>
<span id="cb106-256"><a href="#cb106-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-257"><a href="#cb106-257" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Random effects</span></span>
<span id="cb106-258"><a href="#cb106-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-259"><a href="#cb106-259" aria-hidden="true" tabindex="-1"></a>The set of random effects contains three estimates of variance and standard deviation and refer to the variance components discussed above. The <span class="in">`lsoa_cd`</span>, <span class="in">`msoa_cd`</span> and <span class="in">`Residual`</span> estimates indicate that the extent of estimated LSOA-, MSOA- and individual-level variance is <span class="in">`0.0007603`</span>, <span class="in">`0.0020735`</span> and <span class="in">`0.0025723`</span>, respectively.</span>
<span id="cb106-260"><a href="#cb106-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-261"><a href="#cb106-261" aria-hidden="true" tabindex="-1"></a><span class="fu">### Variance Partition Coefficient (VPC)</span></span>
<span id="cb106-262"><a href="#cb106-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-263"><a href="#cb106-263" aria-hidden="true" tabindex="-1"></a>The purpose of multilevel models is to partition variance in the outcome between the different groupings in the data. We thus often want to know the percentage of variation in the dependent variable accounted by differences across groups i.e. what proportion of the total variance is attributable to variation within-groups, or how much is found between-groups. The statistic to obtain this is termed the variance partition coefficient (VPC), or intraclass correlation.<span class="ot">[^07-multilevel-01-2]</span> For our case, the VPC at the LSOA level indicates that 14% of the variation in percentage of unemployed resident population across OAs can be explained by differences across LSOAs. What is the VPC at the MSOA level?</span>
<span id="cb106-264"><a href="#cb106-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-265"><a href="#cb106-265" aria-hidden="true" tabindex="-1"></a><span class="ot">[^07-multilevel-01-2]: </span>The VPC is equal to the intra-class correlation coefficient which is the correlation between the observations of the dependent variable selected randomly from the same group. For instance, if the VPC is 0.1, we would say that 10% of the variation is between groups and 90% within. The correlation between randomly chosen pairs of observations belonging to the same group is 0.1.</span>
<span id="cb106-266"><a href="#cb106-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-269"><a href="#cb106-269" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-270"><a href="#cb106-270" aria-hidden="true" tabindex="-1"></a>vpc_lsoa <span class="ot">&lt;-</span> <span class="fl">0.0007603</span> <span class="sc">/</span> (<span class="fl">0.0007603</span> <span class="sc">+</span> <span class="fl">0.0020735</span> <span class="sc">+</span> <span class="fl">0.0025723</span>)</span>
<span id="cb106-271"><a href="#cb106-271" aria-hidden="true" tabindex="-1"></a>vpc_lsoa <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb106-272"><a href="#cb106-272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-273"><a href="#cb106-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-274"><a href="#cb106-274" aria-hidden="true" tabindex="-1"></a>You can also obtain the VPC by executing:</span>
<span id="cb106-275"><a href="#cb106-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-278"><a href="#cb106-278" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-279"><a href="#cb106-279" aria-hidden="true" tabindex="-1"></a><span class="fu">summ</span>(model3)</span>
<span id="cb106-280"><a href="#cb106-280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-281"><a href="#cb106-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-282"><a href="#cb106-282" aria-hidden="true" tabindex="-1"></a><span class="fu">### Uncertainty of Estimates</span></span>
<span id="cb106-283"><a href="#cb106-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-284"><a href="#cb106-284" aria-hidden="true" tabindex="-1"></a>You may have noticed that <span class="in">`lme4`</span> does not provide p-values, because of <span class="co">[</span><span class="ot">various reasons</span><span class="co">](https://stat.ethz.ch/pipermail/r-help/2006-May/094765.html)</span> as explained by Doug Bates, one of the author of <span class="in">`lme4`</span>. These explanations mainly refer to the complexity of dealing with varying sample sizes at a given hierarchical level. The number of observations at each hierarchical level varies across individual groupings (i.e. LSOA or MSOA). It may even be one single observation. This has implications for the distributional assumptions, denominator degrees of freedom and how to approximate a "best" solution. Various approaches exist to compute the statistical significance of estimates. We use the <span class="in">`confint`</span> function available within <span class="in">`lme4`</span> to obtain confidence intervals.</span>
<span id="cb106-285"><a href="#cb106-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-288"><a href="#cb106-288" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-289"><a href="#cb106-289" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(model3, <span class="at">level =</span> <span class="fl">0.95</span>)</span>
<span id="cb106-290"><a href="#cb106-290" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-291"><a href="#cb106-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-292"><a href="#cb106-292" aria-hidden="true" tabindex="-1"></a><span class="in">`.sig01`</span> refers to the LSOA level; <span class="in">`.sig02`</span> refers to the MSOA level; and, <span class="in">`.sigma`</span> refers to the OA level.</span>
<span id="cb106-293"><a href="#cb106-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-294"><a href="#cb106-294" aria-hidden="true" tabindex="-1"></a><span class="fu">### Assessing Group-level Variation</span></span>
<span id="cb106-295"><a href="#cb106-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-296"><a href="#cb106-296" aria-hidden="true" tabindex="-1"></a>*Estimated regression coefficients*</span>
<span id="cb106-297"><a href="#cb106-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-298"><a href="#cb106-298" aria-hidden="true" tabindex="-1"></a>In multilevel modelling, our primary interest is in knowing differences across groups. To visualise the estimated model within each group (ie. LSOA and MSOA), we type:</span>
<span id="cb106-299"><a href="#cb106-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-302"><a href="#cb106-302" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-303"><a href="#cb106-303" aria-hidden="true" tabindex="-1"></a>coef_m3 <span class="ot">&lt;-</span> <span class="fu">coef</span>(model3)</span>
<span id="cb106-304"><a href="#cb106-304" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(coef_m3<span class="sc">$</span>lsoa_cd,<span class="dv">5</span>)</span>
<span id="cb106-305"><a href="#cb106-305" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-306"><a href="#cb106-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-307"><a href="#cb106-307" aria-hidden="true" tabindex="-1"></a>The results indicate that the estimated regression line is $y = 0.09915456$ for LSOA <span class="in">`E01006512`</span>; $y = 0.09889615$ for LSOA <span class="in">`E01006513`</span> and so forth. Try getting the estimated model within each MSOA.</span>
<span id="cb106-308"><a href="#cb106-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-309"><a href="#cb106-309" aria-hidden="true" tabindex="-1"></a>*Random effects*</span>
<span id="cb106-310"><a href="#cb106-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-311"><a href="#cb106-311" aria-hidden="true" tabindex="-1"></a>We can look at the estimated group-level (or LSOA-level and MSOA-level) errors; that is, *random effects*:</span>
<span id="cb106-312"><a href="#cb106-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-315"><a href="#cb106-315" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-316"><a href="#cb106-316" aria-hidden="true" tabindex="-1"></a>ranef_m3 <span class="ot">&lt;-</span> <span class="fu">ranef</span>(model3)</span>
<span id="cb106-317"><a href="#cb106-317" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ranef_m3<span class="sc">$</span>lsoa_cd, <span class="dv">5</span>)</span>
<span id="cb106-318"><a href="#cb106-318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-319"><a href="#cb106-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-320"><a href="#cb106-320" aria-hidden="true" tabindex="-1"></a>Group-level errors indicate how much the intercept is shifted up or down in particular groups (ie. LSOAs or MSOAs). Thus, for example, in LSOA <span class="in">`E01006512`</span>, the estimated intercept is <span class="in">`-0.01613353`</span> lower than average, so that the regression line is <span class="in">`(0.1152881 - 0.01613353)`</span> <span class="in">`= 0.09915457`</span> which is what we observed from the call to <span class="in">`coef()`</span>.</span>
<span id="cb106-321"><a href="#cb106-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-322"><a href="#cb106-322" aria-hidden="true" tabindex="-1"></a>We can also obtain group-level errors (*random effects*) by using a simulation approach, labelled "Empirical Bayes" and discussed <span class="co">[</span><span class="ot">here</span><span class="co">](https://stat.ethz.ch/pipermail/r-sig-mixed-models/2009q4/002984.html)</span>. To this end, we run:</span>
<span id="cb106-323"><a href="#cb106-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-326"><a href="#cb106-326" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-327"><a href="#cb106-327" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain estimates</span></span>
<span id="cb106-328"><a href="#cb106-328" aria-hidden="true" tabindex="-1"></a>merTools<span class="sc">::</span><span class="fu">REsim</span>(model3) <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">10</span>)</span>
<span id="cb106-329"><a href="#cb106-329" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-330"><a href="#cb106-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-331"><a href="#cb106-331" aria-hidden="true" tabindex="-1"></a>The results contain the estimated mean, median and standard deviation for the intercept within each group (e.g. LSOA). The mean estimates are similar to those obtained from <span class="in">`ranef`</span> with some small differences due to rounding.</span>
<span id="cb106-332"><a href="#cb106-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-333"><a href="#cb106-333" aria-hidden="true" tabindex="-1"></a>To gain an undertanding of the general pattern of the *random effects*, we can use caterpillar plots via <span class="in">`plotREsim`</span> - reported below. The plot on the right shows the estimated random effects for each MSOA and their respective interval estimate. Note that random effects are on average zero, represented by the red horizontal line. Intervals that do not include zero are in bold. Also note that the width of the confidence interval depends on the standard error of the respective residual estimate, which is inversely related to the size of the sample. The residuals represent an observation departures from the grand mean, so an observation whose confidence interval does not overlap the line at zero (representing the mean proportion of unemployed population across all areas) is said to differ significantly from the average at the 5% level.</span>
<span id="cb106-334"><a href="#cb106-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-337"><a href="#cb106-337" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-338"><a href="#cb106-338" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb106-339"><a href="#cb106-339" aria-hidden="true" tabindex="-1"></a><span class="fu">plotREsim</span>(<span class="fu">REsim</span>(model3)) </span>
<span id="cb106-340"><a href="#cb106-340" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-341"><a href="#cb106-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-342"><a href="#cb106-342" aria-hidden="true" tabindex="-1"></a>Focusing on the plot on the right, we see MSOAs whose mean proportion of unemployed population, assuming no explanatory variables, is lower than average. On the right-hand side of the plot, you will see MSOAs whose mean proportion is higher than average. The MSOAs with the smallest residuals include the districts of Allerton and Hunt Cross, Church, Childwall, Wavertree and Woolton. What districts do we have at the other extreme?</span>
<span id="cb106-343"><a href="#cb106-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-346"><a href="#cb106-346" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-347"><a href="#cb106-347" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">REsim</span>(model3)</span>
<span id="cb106-348"><a href="#cb106-348" aria-hidden="true" tabindex="-1"></a>oa_shp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(msoa_cd, ward_nm, unemp) <span class="sc">%&gt;%</span></span>
<span id="cb106-349"><a href="#cb106-349" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">as.character</span>(msoa_cd) <span class="sc">==</span> <span class="st">"E02001387"</span> <span class="sc">|</span> <span class="fu">as.character</span>(msoa_cd) <span class="sc">==</span> <span class="st">"E02001393"</span>)</span>
<span id="cb106-350"><a href="#cb106-350" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-351"><a href="#cb106-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-352"><a href="#cb106-352" aria-hidden="true" tabindex="-1"></a>We can also map the MSOA-level *random effects*. To this end, we first need to read a shapefile containing data at the MSOA level and merge it with the *random effects* estimates.</span>
<span id="cb106-353"><a href="#cb106-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-356"><a href="#cb106-356" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-357"><a href="#cb106-357" aria-hidden="true" tabindex="-1"></a><span class="co"># read data</span></span>
<span id="cb106-358"><a href="#cb106-358" aria-hidden="true" tabindex="-1"></a>msoa_shp <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/mlm/MSOA.shp"</span>)</span>
<span id="cb106-359"><a href="#cb106-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-360"><a href="#cb106-360" aria-hidden="true" tabindex="-1"></a><span class="co"># create a dataframe for MSOA-level random effects</span></span>
<span id="cb106-361"><a href="#cb106-361" aria-hidden="true" tabindex="-1"></a>re_msoa <span class="ot">&lt;-</span> re <span class="sc">%&gt;%</span> <span class="fu">filter</span>(groupFctr <span class="sc">==</span> <span class="st">"msoa_cd"</span>)</span>
<span id="cb106-362"><a href="#cb106-362" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(re_msoa)</span>
<span id="cb106-363"><a href="#cb106-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-364"><a href="#cb106-364" aria-hidden="true" tabindex="-1"></a><span class="co"># merge data</span></span>
<span id="cb106-365"><a href="#cb106-365" aria-hidden="true" tabindex="-1"></a>msoa_shp <span class="ot">&lt;-</span> <span class="fu">merge</span>(<span class="at">x =</span> msoa_shp, <span class="at">y =</span> re_msoa, <span class="at">by.x =</span> <span class="st">"MSOA_CD"</span>, <span class="at">by.y =</span> <span class="st">"groupID"</span>)</span>
<span id="cb106-366"><a href="#cb106-366" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-367"><a href="#cb106-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-368"><a href="#cb106-368" aria-hidden="true" tabindex="-1"></a>Now we can create our map:</span>
<span id="cb106-369"><a href="#cb106-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-372"><a href="#cb106-372" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-373"><a href="#cb106-373" aria-hidden="true" tabindex="-1"></a><span class="co"># ensure geometry is valid</span></span>
<span id="cb106-374"><a href="#cb106-374" aria-hidden="true" tabindex="-1"></a>msoa_shp <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_make_valid</span>(msoa_shp)</span>
<span id="cb106-375"><a href="#cb106-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-376"><a href="#cb106-376" aria-hidden="true" tabindex="-1"></a><span class="co"># create a map</span></span>
<span id="cb106-377"><a href="#cb106-377" aria-hidden="true" tabindex="-1"></a>legend_title <span class="ot">=</span> <span class="fu">expression</span>(<span class="st">"MSOA-level residuals"</span>)</span>
<span id="cb106-378"><a href="#cb106-378" aria-hidden="true" tabindex="-1"></a>map_msoa <span class="ot">=</span> <span class="fu">tm_shape</span>(msoa_shp) <span class="sc">+</span></span>
<span id="cb106-379"><a href="#cb106-379" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="at">col =</span> <span class="st">"mean"</span>, <span class="at">title =</span> legend_title, <span class="at">palette =</span> <span class="fu">magma</span>(<span class="dv">256</span>, <span class="at">begin =</span> <span class="dv">0</span>, <span class="at">end =</span> <span class="dv">1</span>), <span class="at">style =</span> <span class="st">"cont"</span>) <span class="sc">+</span> </span>
<span id="cb106-380"><a href="#cb106-380" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> .<span class="dv">01</span>)  <span class="sc">+</span> </span>
<span id="cb106-381"><a href="#cb106-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_compass</span>(<span class="at">type =</span> <span class="st">"arrow"</span>, <span class="at">position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"top"</span>) , <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span> </span>
<span id="cb106-382"><a href="#cb106-382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_scale_bar</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">text.size =</span> <span class="fl">0.5</span>, <span class="at">position =</span>  <span class="fu">c</span>(<span class="st">"center"</span>, <span class="st">"bottom"</span>)) </span>
<span id="cb106-383"><a href="#cb106-383" aria-hidden="true" tabindex="-1"></a>map_msoa</span>
<span id="cb106-384"><a href="#cb106-384" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-385"><a href="#cb106-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-386"><a href="#cb106-386" aria-hidden="true" tabindex="-1"></a><span class="fu">### Adding Individual-level Predictors {#sec-indlevel}</span></span>
<span id="cb106-387"><a href="#cb106-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-388"><a href="#cb106-388" aria-hidden="true" tabindex="-1"></a>In this example, $\mu$ represents the sample mean but it could include a collection of independent variables or predictors. To explain the logic, we will assume that unemployment is strongly associated to long-term illness. We could expect that long-term illness (<span class="in">`lt_ill`</span>) will reduce the chances of working and therefore being unemployed. Note that our focus is on the relationship, not on establishing causation. Specifically we want to estimate the relationship between unemployment and long-term illness and we are interested in variations in OA-level unemployment by MSOAs so we will estimate the following two-level model:</span>
<span id="cb106-389"><a href="#cb106-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-390"><a href="#cb106-390" aria-hidden="true" tabindex="-1"></a>OA-level:</span>
<span id="cb106-391"><a href="#cb106-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-392"><a href="#cb106-392" aria-hidden="true" tabindex="-1"></a>$$y_{ij} = \beta_{0j} + \beta_{1}x_{ij} + e_{ij}$$ MSOA-level:</span>
<span id="cb106-393"><a href="#cb106-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-394"><a href="#cb106-394" aria-hidden="true" tabindex="-1"></a>$$\beta_{0j} = \beta_{0} + u_{0j}$$ Replacing the first equation into the second, we have:</span>
<span id="cb106-395"><a href="#cb106-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-396"><a href="#cb106-396" aria-hidden="true" tabindex="-1"></a>$$y_{ij} = (\beta_{0} + u_{0j}) + \beta_{1}x_{ij} + e_{ij}$$ where $y$ the proportion of unemployed population in OA $i$ within MSOA $j$; $\beta_{0}$ is the fixed intercept (averaging over all MSOAs); $u_{0j}$ represents the MSOA-level residuals or *random effects*; $\beta_{0}$ and $u_{0j}$ together represent the varying-intercept; $\beta_{1}$ is the slope coefficient; $x_{ij}$ represents the percentage of long-term illness population; and, $e_{ij}$ is the individual-level residuals.</span>
<span id="cb106-397"><a href="#cb106-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-398"><a href="#cb106-398" aria-hidden="true" tabindex="-1"></a>We estimate the model executing:</span>
<span id="cb106-399"><a href="#cb106-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-402"><a href="#cb106-402" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-403"><a href="#cb106-403" aria-hidden="true" tabindex="-1"></a><span class="co"># change to proportion</span></span>
<span id="cb106-404"><a href="#cb106-404" aria-hidden="true" tabindex="-1"></a>oa_shp<span class="sc">$</span>lt_ill <span class="ot">&lt;-</span> lt_ill<span class="sc">/</span><span class="dv">100</span></span>
<span id="cb106-405"><a href="#cb106-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-406"><a href="#cb106-406" aria-hidden="true" tabindex="-1"></a><span class="co"># specify a model equation</span></span>
<span id="cb106-407"><a href="#cb106-407" aria-hidden="true" tabindex="-1"></a>eq4 <span class="ot">&lt;-</span> unemp <span class="sc">~</span> lt_ill <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> msoa_cd)</span>
<span id="cb106-408"><a href="#cb106-408" aria-hidden="true" tabindex="-1"></a>model4 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(eq4, <span class="at">data =</span> oa_shp)</span>
<span id="cb106-409"><a href="#cb106-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-410"><a href="#cb106-410" aria-hidden="true" tabindex="-1"></a><span class="co"># estimates</span></span>
<span id="cb106-411"><a href="#cb106-411" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model4)</span>
<span id="cb106-412"><a href="#cb106-412" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-413"><a href="#cb106-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-414"><a href="#cb106-414" aria-hidden="true" tabindex="-1"></a>*Fixed effects*: model averaging over MSOAs</span>
<span id="cb106-415"><a href="#cb106-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-418"><a href="#cb106-418" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-419"><a href="#cb106-419" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(model4)</span>
<span id="cb106-420"><a href="#cb106-420" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-421"><a href="#cb106-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-422"><a href="#cb106-422" aria-hidden="true" tabindex="-1"></a>yields an estimated regression line in an average McSOA: $y = 0.04681959 + 0.29588110x$</span>
<span id="cb106-423"><a href="#cb106-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-424"><a href="#cb106-424" aria-hidden="true" tabindex="-1"></a>*Random effects*: MSOA-level errors</span>
<span id="cb106-425"><a href="#cb106-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-428"><a href="#cb106-428" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-429"><a href="#cb106-429" aria-hidden="true" tabindex="-1"></a>ranef_m4 <span class="ot">&lt;-</span> <span class="fu">ranef</span>(model4)</span>
<span id="cb106-430"><a href="#cb106-430" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ranef_m4<span class="sc">$</span>msoa_cd, <span class="dv">5</span>)</span>
<span id="cb106-431"><a href="#cb106-431" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-432"><a href="#cb106-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-433"><a href="#cb106-433" aria-hidden="true" tabindex="-1"></a>yields an estimated intercept for MSOA <span class="in">`E02001347`</span> which is <span class="in">`0.017474815`</span> lower than the average with a regression line: <span class="in">`(0.04681959 - 0.017474815) + 0.29588110x`</span> <span class="in">`=`</span> <span class="in">`0.02934478 + 0.29588110x`</span>. You can confirm this by looking at the estimated model within each MSOA by executing (remove the <span class="in">`#`</span> sign):</span>
<span id="cb106-434"><a href="#cb106-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-437"><a href="#cb106-437" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-438"><a href="#cb106-438" aria-hidden="true" tabindex="-1"></a><span class="co">#coef(model4)</span></span>
<span id="cb106-439"><a href="#cb106-439" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-440"><a href="#cb106-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-441"><a href="#cb106-441" aria-hidden="true" tabindex="-1"></a>*Fixed effect correlations*</span>
<span id="cb106-442"><a href="#cb106-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-443"><a href="#cb106-443" aria-hidden="true" tabindex="-1"></a>In the bottom of the output, we have the correlations between the fixed-effects estimates. In our example, it refers to the correlation between $\beta_{0}$ and $\beta_{1}$. It is negative indicating that in MSOAs where the relationship between unemployment and long-term illness is greater, as measured by $\beta_{1}$, the average proportion of unemployed people tends to be smaller, as captured by $\beta_{0}$.</span>
<span id="cb106-444"><a href="#cb106-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-445"><a href="#cb106-445" aria-hidden="true" tabindex="-1"></a><span class="fu">### Adding Group-level Predictors {#sec-grouplevel}</span></span>
<span id="cb106-446"><a href="#cb106-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-447"><a href="#cb106-447" aria-hidden="true" tabindex="-1"></a>We can also add group-level predictors. We use the formulation:</span>
<span id="cb106-448"><a href="#cb106-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-449"><a href="#cb106-449" aria-hidden="true" tabindex="-1"></a>OA-level:</span>
<span id="cb106-450"><a href="#cb106-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-451"><a href="#cb106-451" aria-hidden="true" tabindex="-1"></a>$$y_{ij} = \beta_{0j} + \beta_{1}x_{ij} + e_{ij}$$</span>
<span id="cb106-452"><a href="#cb106-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-453"><a href="#cb106-453" aria-hidden="true" tabindex="-1"></a>MSOA-level:</span>
<span id="cb106-454"><a href="#cb106-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-455"><a href="#cb106-455" aria-hidden="true" tabindex="-1"></a>$$\beta_{0j} = \beta_{0} + \gamma_{1}m_{j} + u_{0j}$$</span>
<span id="cb106-456"><a href="#cb106-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-457"><a href="#cb106-457" aria-hidden="true" tabindex="-1"></a>where $x_{ij}$ is the OA-level proportion of population suffering long-term illness and $m_{j}$ is the MSOA-level proportion of male population. We first need to create this group-level predictor:</span>
<span id="cb106-458"><a href="#cb106-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-461"><a href="#cb106-461" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-462"><a href="#cb106-462" aria-hidden="true" tabindex="-1"></a><span class="co"># detach OA shp and attach MSOA shp</span></span>
<span id="cb106-463"><a href="#cb106-463" aria-hidden="true" tabindex="-1"></a><span class="fu">detach</span>(oa_shp)</span>
<span id="cb106-464"><a href="#cb106-464" aria-hidden="true" tabindex="-1"></a><span class="fu">attach</span>(msoa_shp)</span>
<span id="cb106-465"><a href="#cb106-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-466"><a href="#cb106-466" aria-hidden="true" tabindex="-1"></a><span class="co"># group-level predictor</span></span>
<span id="cb106-467"><a href="#cb106-467" aria-hidden="true" tabindex="-1"></a>msoa_shp<span class="sc">$</span>pr_male <span class="ot">&lt;-</span> males<span class="sc">/</span>pop</span>
<span id="cb106-468"><a href="#cb106-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-469"><a href="#cb106-469" aria-hidden="true" tabindex="-1"></a><span class="co"># remove geometries</span></span>
<span id="cb106-470"><a href="#cb106-470" aria-hidden="true" tabindex="-1"></a>msoa_df <span class="ot">&lt;-</span> <span class="st">`</span><span class="at">st_geometry&lt;-</span><span class="st">`</span>(msoa_shp, <span class="cn">NULL</span>)</span>
<span id="cb106-471"><a href="#cb106-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-472"><a href="#cb106-472" aria-hidden="true" tabindex="-1"></a><span class="co"># select variables</span></span>
<span id="cb106-473"><a href="#cb106-473" aria-hidden="true" tabindex="-1"></a>msoa_df <span class="ot">&lt;-</span> msoa_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(MSOA_CD, pop, pr_male)</span>
<span id="cb106-474"><a href="#cb106-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-475"><a href="#cb106-475" aria-hidden="true" tabindex="-1"></a><span class="co"># merge data sets</span></span>
<span id="cb106-476"><a href="#cb106-476" aria-hidden="true" tabindex="-1"></a>oa_shp <span class="ot">&lt;-</span> <span class="fu">merge</span>(<span class="at">x=</span>oa_shp, <span class="at">y=</span>msoa_df, <span class="at">by.x =</span> <span class="st">"msoa_cd"</span>, <span class="at">by.y=</span><span class="st">"MSOA_CD"</span>)</span>
<span id="cb106-477"><a href="#cb106-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-478"><a href="#cb106-478" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect data</span></span>
<span id="cb106-479"><a href="#cb106-479" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(oa_shp[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="fu">c</span>(<span class="st">"msoa_cd"</span>, <span class="st">"oa_cd"</span>, <span class="st">"unemp"</span>, <span class="st">"pr_male"</span>)])</span>
<span id="cb106-480"><a href="#cb106-480" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-481"><a href="#cb106-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-482"><a href="#cb106-482" aria-hidden="true" tabindex="-1"></a>We can now estimate our model:</span>
<span id="cb106-483"><a href="#cb106-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-486"><a href="#cb106-486" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-487"><a href="#cb106-487" aria-hidden="true" tabindex="-1"></a><span class="fu">detach</span>(msoa_shp)</span>
<span id="cb106-488"><a href="#cb106-488" aria-hidden="true" tabindex="-1"></a><span class="fu">attach</span>(oa_shp)</span>
<span id="cb106-489"><a href="#cb106-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-490"><a href="#cb106-490" aria-hidden="true" tabindex="-1"></a><span class="co"># specify a model equation</span></span>
<span id="cb106-491"><a href="#cb106-491" aria-hidden="true" tabindex="-1"></a>eq5 <span class="ot">&lt;-</span> unemp <span class="sc">~</span> lt_ill <span class="sc">+</span> pr_male <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> msoa_cd)</span>
<span id="cb106-492"><a href="#cb106-492" aria-hidden="true" tabindex="-1"></a>model5 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(eq5, <span class="at">data =</span> oa_shp)</span>
<span id="cb106-493"><a href="#cb106-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-494"><a href="#cb106-494" aria-hidden="true" tabindex="-1"></a><span class="co"># estimates</span></span>
<span id="cb106-495"><a href="#cb106-495" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model5)</span>
<span id="cb106-496"><a href="#cb106-496" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-497"><a href="#cb106-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-498"><a href="#cb106-498" aria-hidden="true" tabindex="-1"></a>This model includes the proportion of males and intercepts that vary by MSOA. The <span class="in">`lmer()`</span> function only accepts predictors at the individual level, so we have included data on the proportion of male population at this level. Explore and interpret the model running the functions below:</span>
<span id="cb106-499"><a href="#cb106-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-502"><a href="#cb106-502" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-503"><a href="#cb106-503" aria-hidden="true" tabindex="-1"></a><span class="co"># fixed effects</span></span>
<span id="cb106-504"><a href="#cb106-504" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(model5)</span>
<span id="cb106-505"><a href="#cb106-505" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-506"><a href="#cb106-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-509"><a href="#cb106-509" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-510"><a href="#cb106-510" aria-hidden="true" tabindex="-1"></a><span class="co"># random effects</span></span>
<span id="cb106-511"><a href="#cb106-511" aria-hidden="true" tabindex="-1"></a>ranef_m5 <span class="ot">&lt;-</span> <span class="fu">ranef</span>(model5)</span>
<span id="cb106-512"><a href="#cb106-512" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ranef_m5<span class="sc">$</span>msoa_cd, <span class="dv">5</span>)</span>
<span id="cb106-513"><a href="#cb106-513" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-514"><a href="#cb106-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-515"><a href="#cb106-515" aria-hidden="true" tabindex="-1"></a>Adding group-level predictors tends to improve inferences for group coefficients. Examine the confidence intervals, in order to evalute how the precision of our estimates of the MSOA intercepts have changed. *Have confidence intervals for the intercepts of Model 4 and 5 increased or reduced?* Hint: look at how to get the confidence intervals above.</span>
<span id="cb106-516"><a href="#cb106-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-517"><a href="#cb106-517" aria-hidden="true" tabindex="-1"></a><span class="fu">## Questions</span></span>
<span id="cb106-518"><a href="#cb106-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-519"><a href="#cb106-519" aria-hidden="true" tabindex="-1"></a>For the second assignment, we will be using a different dataset comprising information on COVID-19 cases, census data and the Index of Multiple Deprivation (IMD) for England. The data set is similar in structured to that used in this chapter. It is hierarchically organised into 149 Upper Tier Local Authority Districts (UTLADs) within 9 Regions and has 508 variables - see Chapter \@ref(datasets) for a more detailed description of the data.</span>
<span id="cb106-520"><a href="#cb106-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-523"><a href="#cb106-523" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-524"><a href="#cb106-524" aria-hidden="true" tabindex="-1"></a>sdf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/assignment_2_covid/covid19_eng.gpkg"</span>)</span>
<span id="cb106-525"><a href="#cb106-525" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-526"><a href="#cb106-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-527"><a href="#cb106-527" aria-hidden="true" tabindex="-1"></a>Here we see a selection of 10 variables for 5 UTLADs.</span>
<span id="cb106-528"><a href="#cb106-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-531"><a href="#cb106-531" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-532"><a href="#cb106-532" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sdf[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,<span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">9</span>,<span class="dv">10</span>,<span class="dv">381</span>,<span class="dv">385</span>,<span class="dv">386</span>,<span class="dv">387</span>,<span class="dv">403</span>,<span class="dv">406</span>)])</span>
<span id="cb106-533"><a href="#cb106-533" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-534"><a href="#cb106-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-535"><a href="#cb106-535" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`ctyua19nm`</span>: Upper Tier Local Authority District name</span>
<span id="cb106-536"><a href="#cb106-536" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`Region`</span>: Region name</span>
<span id="cb106-537"><a href="#cb106-537" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`X2020.01.31`</span>: COVID-19 cases on January 31st 2020</span>
<span id="cb106-538"><a href="#cb106-538" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`X2020.02.01`</span>: COVID-19 cases on February 1st 2020</span>
<span id="cb106-539"><a href="#cb106-539" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`IMD...Average.score`</span>: Average IMD score for UTLADs - see <span class="co">[</span><span class="ot">File 11: upper-tier local authority summaries</span><span class="co">](https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019)</span> for information on this and associated indicators.</span>
<span id="cb106-540"><a href="#cb106-540" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`Residents`</span>: Number of residents</span>
<span id="cb106-541"><a href="#cb106-541" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`Households`</span>: Number of households</span>
<span id="cb106-542"><a href="#cb106-542" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`Dwellings`</span>: Number of dwellings</span>
<span id="cb106-543"><a href="#cb106-543" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`Age_85plus`</span>: Number of people aged 85 and over</span>
<span id="cb106-544"><a href="#cb106-544" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`White_British_and_Irish`</span>: Number of white British and Irish people</span>
<span id="cb106-545"><a href="#cb106-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-546"><a href="#cb106-546" aria-hidden="true" tabindex="-1"></a>Note that variable names relating to the daily COVID-19 cases are organised in the following way: <span class="in">`X`</span> stands for daily COVID-19 cases, followed by the year (i.e. 2020, 2021); month (i.e. January to December); and day (i.e. 01 to 31).</span>
<span id="cb106-547"><a href="#cb106-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-548"><a href="#cb106-548" aria-hidden="true" tabindex="-1"></a>Using these data, you are required to address the following challenges:</span>
<span id="cb106-549"><a href="#cb106-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-550"><a href="#cb106-550" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Fit a varying-intercept model with no explanatory variables. Let the intercept to vary by region.</span>
<span id="cb106-551"><a href="#cb106-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-552"><a href="#cb106-552" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Fit a varying-intercept model with including at least three explanatory variables.</span>
<span id="cb106-553"><a href="#cb106-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-554"><a href="#cb106-554" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Compute the Variance Partition Coefficient (VPC) for the models estimated according to points 1 and 2 above.</span>
<span id="cb106-555"><a href="#cb106-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-556"><a href="#cb106-556" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>Create caterpillar plots to visualise the varying intercepts.</span>
<span id="cb106-557"><a href="#cb106-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-558"><a href="#cb106-558" aria-hidden="true" tabindex="-1"></a>Analyse and discuss: 1. the extent of variation in the dependent variables at the two geographical scales (variation at which geographical scale explains most of variance in your dependent variable); 2. the varying intercept estimate(s) from your model(s) (what can they tell you about the difference between groups / areas? are they statistically significantly different?);</span>
<span id="cb106-559"><a href="#cb106-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-560"><a href="#cb106-560" aria-hidden="true" tabindex="-1"></a>Ensure you appropriately describe the structure of the data and identify the various geographical scales of analysis (i.e. level-1 and level-2 units)</span>
<span id="cb106-561"><a href="#cb106-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-562"><a href="#cb106-562" aria-hidden="true" tabindex="-1"></a>In addressing the challenges in this and following chapters, you have some flexibility to be creative. A set of key factors to consider:</span>
<span id="cb106-563"><a href="#cb106-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-564"><a href="#cb106-564" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>*Dependent Variable*: We will seek to explain daily COVID-19 cases, and you will need to make a decision as to:</span>
<span id="cb106-565"><a href="#cb106-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-566"><a href="#cb106-566" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Daily vs cumulative COVID-19 cases*. Given that we will be focusing on cross-sectional models (i.e. models for one snapshot), you can focus on modelling daily cases at one specific date or cumulative daily cases over a period of time.</span>
<span id="cb106-567"><a href="#cb106-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-568"><a href="#cb106-568" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Time period*. You can select the date or period of time that you will focus your analysis on.</span>
<span id="cb106-569"><a href="#cb106-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-570"><a href="#cb106-570" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Use risk of COVID-19 infection*. The dependent variable should be the risk or rate of COVID-19 infection.</span>
<span id="cb106-571"><a href="#cb106-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-572"><a href="#cb106-572" aria-hidden="true" tabindex="-1"></a>For example, the risk of COVID-19 infection for the period (i.e. between Dec. 1st, 2020 - January 29th, 2021) comprising the third wave of the pandemic in the United Kingdom can be computed as:</span>
<span id="cb106-573"><a href="#cb106-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-576"><a href="#cb106-576" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-577"><a href="#cb106-577" aria-hidden="true" tabindex="-1"></a><span class="co"># computing cumulative COVID cases for  01/12/2020 - 29/01/2021</span></span>
<span id="cb106-578"><a href="#cb106-578" aria-hidden="true" tabindex="-1"></a>sdf[, <span class="dv">509</span>] <span class="ot">&lt;-</span> sdf <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="st">"X2020.12.01"</span><span class="sc">:</span><span class="st">"X2021.01.29"</span>) <span class="sc">%&gt;%</span> <span class="co"># select COVID cases 01/12/2020 - 29/01/2021</span></span>
<span id="cb106-579"><a href="#cb106-579" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cum_covid =</span> <span class="fu">rowSums</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric)))) <span class="sc">%&gt;%</span> <span class="co"># sum daily cases</span></span>
<span id="cb106-580"><a href="#cb106-580" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(cum_covid) <span class="sc">%&gt;%</span> <span class="co"># select cumulative cases</span></span>
<span id="cb106-581"><a href="#cb106-581" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_set_geometry</span>(., <span class="cn">NULL</span>) <span class="co"># set geometry to NULL</span></span>
<span id="cb106-582"><a href="#cb106-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-583"><a href="#cb106-583" aria-hidden="true" tabindex="-1"></a><span class="co"># computing risk of infection</span></span>
<span id="cb106-584"><a href="#cb106-584" aria-hidden="true" tabindex="-1"></a>sdf <span class="ot">&lt;-</span> sdf <span class="sc">%&gt;%</span>  <span class="fu">mutate</span>(</span>
<span id="cb106-585"><a href="#cb106-585" aria-hidden="true" tabindex="-1"></a>  <span class="at">covid19_r =</span> <span class="fu">round</span>((cum_covid <span class="sc">/</span> Residents ) <span class="sc">*</span> <span class="dv">1000</span>) </span>
<span id="cb106-586"><a href="#cb106-586" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-587"><a href="#cb106-587" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-588"><a href="#cb106-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-589"><a href="#cb106-589" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>*Explanatory variables*:</span>
<span id="cb106-590"><a href="#cb106-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-591"><a href="#cb106-591" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*At least 3*. Use at least 3 explanatory variables. There is no maximum limit but consider your model to be parsimonious.</span>
<span id="cb106-592"><a href="#cb106-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-593"><a href="#cb106-593" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Choice your set*. Select the set of variables you consider appropriate / interesting. Make sure you justify your choice based on evidence and/or theory.</span>
<span id="cb106-594"><a href="#cb106-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-595"><a href="#cb106-595" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Percentages / Proportions*. Use percentages or proportions to capture the composition of places, rather than numbers of people, households or dwellings. For this, ensure you are using the appropriate denominator.</span>
<span id="cb106-596"><a href="#cb106-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-597"><a href="#cb106-597" aria-hidden="true" tabindex="-1"></a>For instance, if you want to capture the relationship between cumulative COVID-19 cases and overcrowding, share of elderly population and nonwhite minorities, use the following variables</span>
<span id="cb106-598"><a href="#cb106-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-601"><a href="#cb106-601" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-602"><a href="#cb106-602" aria-hidden="true" tabindex="-1"></a>sdf <span class="ot">&lt;-</span> sdf <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb106-603"><a href="#cb106-603" aria-hidden="true" tabindex="-1"></a>  <span class="at">crowded_hou =</span> Crowded_housing <span class="sc">/</span> Households, <span class="co"># share of crowded housing</span></span>
<span id="cb106-604"><a href="#cb106-604" aria-hidden="true" tabindex="-1"></a>  <span class="at">elderly =</span> (Age_85plus) <span class="sc">/</span> Residents, <span class="co"># share of population aged 65+</span></span>
<span id="cb106-605"><a href="#cb106-605" aria-hidden="true" tabindex="-1"></a>  <span class="at">ethnic =</span> (Mixed <span class="sc">+</span> Indian <span class="sc">+</span> Pakistani <span class="sc">+</span> Bangladeshi <span class="sc">+</span> Chinese <span class="sc">+</span> Other_Asian <span class="sc">+</span> Black <span class="sc">+</span> Other_ethnicity) <span class="sc">/</span> Residents, <span class="co"># share of nonwhite population</span></span>
<span id="cb106-606"><a href="#cb106-606" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-607"><a href="#cb106-607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-608"><a href="#cb106-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-609"><a href="#cb106-609" aria-hidden="true" tabindex="-1"></a>**ADVICE**: Create a new spatial data frame including only the variables you will analyse. For example:</span>
<span id="cb106-610"><a href="#cb106-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-613"><a href="#cb106-613" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-614"><a href="#cb106-614" aria-hidden="true" tabindex="-1"></a>nsdf <span class="ot">&lt;-</span> sdf  <span class="sc">%&gt;%</span>  dplyr<span class="sc">::</span><span class="fu">select</span>(objectid, </span>
<span id="cb106-615"><a href="#cb106-615" aria-hidden="true" tabindex="-1"></a>                         ctyua19cd, </span>
<span id="cb106-616"><a href="#cb106-616" aria-hidden="true" tabindex="-1"></a>                         ctyua19nm, </span>
<span id="cb106-617"><a href="#cb106-617" aria-hidden="true" tabindex="-1"></a>                         Region, </span>
<span id="cb106-618"><a href="#cb106-618" aria-hidden="true" tabindex="-1"></a>                         covid19_r, </span>
<span id="cb106-619"><a href="#cb106-619" aria-hidden="true" tabindex="-1"></a>                         crowded_hou, </span>
<span id="cb106-620"><a href="#cb106-620" aria-hidden="true" tabindex="-1"></a>                         elderly, </span>
<span id="cb106-621"><a href="#cb106-621" aria-hidden="true" tabindex="-1"></a>                         ethnic, </span>
<span id="cb106-622"><a href="#cb106-622" aria-hidden="true" tabindex="-1"></a>                         Residents)</span>
<span id="cb106-623"><a href="#cb106-623" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-624"><a href="#cb106-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-625"><a href="#cb106-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-626"><a href="#cb106-626" aria-hidden="true" tabindex="-1"></a>This chapter explains varying slopes and draws on the following references:</span>
<span id="cb106-627"><a href="#cb106-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-628"><a href="#cb106-628" aria-hidden="true" tabindex="-1"></a>The content of this chapter is based on:</span>
<span id="cb106-629"><a href="#cb106-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-630"><a href="#cb106-630" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>@gelman2006data provides an excellent and intuitive explanation of multilevel modelling and data analysis in general. Read Part 2A for a really good explanation of multilevel models.</span>
<span id="cb106-631"><a href="#cb106-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-632"><a href="#cb106-632" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>@bristol2020 is an useful online resource on multilevel modelling and is free!</span>
<span id="cb106-633"><a href="#cb106-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-634"><a href="#cb106-634" aria-hidden="true" tabindex="-1"></a><span class="fu">## Dependencies</span></span>
<span id="cb106-635"><a href="#cb106-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-636"><a href="#cb106-636" aria-hidden="true" tabindex="-1"></a>This chapter uses the following libraries which are listed in the @sec-dependencies in Chapter 1:</span>
<span id="cb106-637"><a href="#cb106-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-638"><a href="#cb106-638" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message = FALSE}</span></span>
<span id="cb106-639"><a href="#cb106-639" aria-hidden="true" tabindex="-1"></a><span class="co"># Data manipulation, transformation and visualisation</span></span>
<span id="cb106-640"><a href="#cb106-640" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb106-641"><a href="#cb106-641" aria-hidden="true" tabindex="-1"></a><span class="co"># Nice tables</span></span>
<span id="cb106-642"><a href="#cb106-642" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb106-643"><a href="#cb106-643" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple features (a standardised way to encode vector data ie. points, lines, polygons)</span></span>
<span id="cb106-644"><a href="#cb106-644" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf) </span>
<span id="cb106-645"><a href="#cb106-645" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial objects conversion</span></span>
<span id="cb106-646"><a href="#cb106-646" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sp) </span>
<span id="cb106-647"><a href="#cb106-647" aria-hidden="true" tabindex="-1"></a><span class="co"># Thematic maps</span></span>
<span id="cb106-648"><a href="#cb106-648" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap) </span>
<span id="cb106-649"><a href="#cb106-649" aria-hidden="true" tabindex="-1"></a><span class="co"># Colour palettes</span></span>
<span id="cb106-650"><a href="#cb106-650" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer) </span>
<span id="cb106-651"><a href="#cb106-651" aria-hidden="true" tabindex="-1"></a><span class="co"># More colour palettes</span></span>
<span id="cb106-652"><a href="#cb106-652" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis) <span class="co"># nice colour schemes</span></span>
<span id="cb106-653"><a href="#cb106-653" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting multilevel models</span></span>
<span id="cb106-654"><a href="#cb106-654" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb106-655"><a href="#cb106-655" aria-hidden="true" tabindex="-1"></a><span class="co"># Tools for extracting information generated by lme4</span></span>
<span id="cb106-656"><a href="#cb106-656" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(merTools)</span>
<span id="cb106-657"><a href="#cb106-657" aria-hidden="true" tabindex="-1"></a><span class="co"># Exportable regression tables</span></span>
<span id="cb106-658"><a href="#cb106-658" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jtools)</span>
<span id="cb106-659"><a href="#cb106-659" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stargazer)</span>
<span id="cb106-660"><a href="#cb106-660" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sjPlot)</span>
<span id="cb106-661"><a href="#cb106-661" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-662"><a href="#cb106-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-663"><a href="#cb106-663" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data</span></span>
<span id="cb106-664"><a href="#cb106-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-665"><a href="#cb106-665" aria-hidden="true" tabindex="-1"></a>For this chapter, we will data for Liverpool from England's 2011 Census. The original source is the <span class="co">[</span><span class="ot">Office of National Statistics</span><span class="co">](https://www.nomisweb.co.uk/home/census2001.asp)</span> and the dataset comprises a number of selected variables capturing demographic, health and socio-economic of the local resident population at four geographic levels: Output Area (OA), Lower Super Output Area (LSOA), Middle Super Output Area (MSOA) and Local Authority District (LAD). The variables include population counts and percentages. For a description of the variables, see the readme file in the mlm data folder.<span class="ot">[^08-multilevel-02-1]</span></span>
<span id="cb106-666"><a href="#cb106-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-667"><a href="#cb106-667" aria-hidden="true" tabindex="-1"></a><span class="ot">[^08-multilevel-02-1]: </span>Read the file in R by executing <span class="in">`read_tsv("data/mlm/readme.txt")`</span> . Ensure the library <span class="in">`readr`</span> is installed before running <span class="in">`read_tsv`</span>.</span>
<span id="cb106-668"><a href="#cb106-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-669"><a href="#cb106-669" aria-hidden="true" tabindex="-1"></a>Let us read the data:</span>
<span id="cb106-670"><a href="#cb106-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-671"><a href="#cb106-671" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, results = 'hide'}</span></span>
<span id="cb106-672"><a href="#cb106-672" aria-hidden="true" tabindex="-1"></a><span class="co"># clean workspace</span></span>
<span id="cb106-673"><a href="#cb106-673" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb106-674"><a href="#cb106-674" aria-hidden="true" tabindex="-1"></a><span class="co"># read data</span></span>
<span id="cb106-675"><a href="#cb106-675" aria-hidden="true" tabindex="-1"></a>oa_shp <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/mlm/OA.shp"</span>)</span>
<span id="cb106-676"><a href="#cb106-676" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-677"><a href="#cb106-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-678"><a href="#cb106-678" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conceptual Overview</span></span>
<span id="cb106-679"><a href="#cb106-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-680"><a href="#cb106-680" aria-hidden="true" tabindex="-1"></a>So far, we have estimated varying-intercept models; that is, when the intercept ($\beta_{0}$) is allowed to vary by group (eg. geographical area) - as shown in Fig. 1(a). The strength of the relationship between $y$ (i.e. unemployment rate) and $x$ (long-term illness) has been assumed to be the same across groups (i.e. MSOAs), as captured by the regression slope ($\beta_{1}$). Yet it can also vary by group as shown in Fig. 1(b), or we can observe group variability for both intercepts and slopes as represented in Fig. 1(c).</span>
<span id="cb106-681"><a href="#cb106-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-682"><a href="#cb106-682" aria-hidden="true" tabindex="-1"></a><span class="al">![Fig. 1. Linear regression model with (a) varying intercepts, (b) varying slopes, and (c) both. Source: @gelman2006data p.238.](figs/ch6/fig11.1_Gelman_Hill.png)</span></span>
<span id="cb106-683"><a href="#cb106-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-684"><a href="#cb106-684" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exploratory Analysis: Varying Slopes</span></span>
<span id="cb106-685"><a href="#cb106-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-686"><a href="#cb106-686" aria-hidden="true" tabindex="-1"></a>Let's then explore if there is variation in the relationship between unemployment rate and the share of population in long-term illness. We do this by selecting the 8 MSOAs containing OAs with the highest unemployment rates in Liverpool.</span>
<span id="cb106-687"><a href="#cb106-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-690"><a href="#cb106-690" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-691"><a href="#cb106-691" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort data </span></span>
<span id="cb106-692"><a href="#cb106-692" aria-hidden="true" tabindex="-1"></a>oa_shp <span class="ot">&lt;-</span> oa_shp <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="sc">-</span>unemp)</span>
<span id="cb106-693"><a href="#cb106-693" aria-hidden="true" tabindex="-1"></a>oa_shp[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, <span class="fu">c</span>(<span class="st">"msoa_cd"</span>, <span class="st">"unemp"</span>)]</span>
<span id="cb106-694"><a href="#cb106-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-695"><a href="#cb106-695" aria-hidden="true" tabindex="-1"></a><span class="co"># Select MSOAs</span></span>
<span id="cb106-696"><a href="#cb106-696" aria-hidden="true" tabindex="-1"></a>s_t8 <span class="ot">&lt;-</span> oa_shp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb106-697"><a href="#cb106-697" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.character</span>(msoa_cd) <span class="sc">%in%</span> <span class="fu">c</span>(</span>
<span id="cb106-698"><a href="#cb106-698" aria-hidden="true" tabindex="-1"></a>      <span class="st">"E02001354"</span>, </span>
<span id="cb106-699"><a href="#cb106-699" aria-hidden="true" tabindex="-1"></a>      <span class="st">"E02001369"</span>, </span>
<span id="cb106-700"><a href="#cb106-700" aria-hidden="true" tabindex="-1"></a>      <span class="st">"E02001366"</span>, </span>
<span id="cb106-701"><a href="#cb106-701" aria-hidden="true" tabindex="-1"></a>      <span class="st">"E02001365"</span>, </span>
<span id="cb106-702"><a href="#cb106-702" aria-hidden="true" tabindex="-1"></a>      <span class="st">"E02001370"</span>, </span>
<span id="cb106-703"><a href="#cb106-703" aria-hidden="true" tabindex="-1"></a>      <span class="st">"E02001390"</span>, </span>
<span id="cb106-704"><a href="#cb106-704" aria-hidden="true" tabindex="-1"></a>      <span class="st">"E02001368"</span>, </span>
<span id="cb106-705"><a href="#cb106-705" aria-hidden="true" tabindex="-1"></a>      <span class="st">"E02001385"</span>)</span>
<span id="cb106-706"><a href="#cb106-706" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-707"><a href="#cb106-707" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-708"><a href="#cb106-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-709"><a href="#cb106-709" aria-hidden="true" tabindex="-1"></a>And then we generate a set of scatter plots and draw regression lines for each MSOA.</span>
<span id="cb106-710"><a href="#cb106-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-713"><a href="#cb106-713" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-714"><a href="#cb106-714" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(s_t8, <span class="fu">aes</span>(<span class="at">x =</span> lt_ill, <span class="at">y =</span> unemp)) <span class="sc">+</span> </span>
<span id="cb106-715"><a href="#cb106-715" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb106-716"><a href="#cb106-716" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>) <span class="sc">+</span></span>
<span id="cb106-717"><a href="#cb106-717" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> msoa_cd, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb106-718"><a href="#cb106-718" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Unemployment rate"</span>) <span class="sc">+</span> </span>
<span id="cb106-719"><a href="#cb106-719" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Long-term Illness (%)"</span>) <span class="sc">+</span></span>
<span id="cb106-720"><a href="#cb106-720" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb106-721"><a href="#cb106-721" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-722"><a href="#cb106-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-723"><a href="#cb106-723" aria-hidden="true" tabindex="-1"></a>We can observe great variability in the relationship between unemployment rates and the percentage of population in long-term illness. A strong and positive relationship exists in MSOA <span class="in">`E02001366`</span> (Tuebrook and Stoneycroft), while it is negative in MSOA <span class="in">`E02001370`</span> (Everton) and neutral in MSOA <span class="in">`E02001390`</span> (Princes Park &amp; Riverside). This visual inspection suggests that accounting for differences in the way unmployment rates relate to long-term illness is important. Contextual factors may differ across MSOAs in systematic ways.</span>
<span id="cb106-724"><a href="#cb106-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-725"><a href="#cb106-725" aria-hidden="true" tabindex="-1"></a><span class="fu">## Estimating Varying Intercept and Slopes Models</span></span>
<span id="cb106-726"><a href="#cb106-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-727"><a href="#cb106-727" aria-hidden="true" tabindex="-1"></a>A way to capture for these group differences in the relationship between unemployment rates and long-term illness is to allow the relevant slope to vary by group (i.e. MSOA). We can do this estimating the following model:</span>
<span id="cb106-728"><a href="#cb106-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-729"><a href="#cb106-729" aria-hidden="true" tabindex="-1"></a>OA-level:</span>
<span id="cb106-730"><a href="#cb106-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-731"><a href="#cb106-731" aria-hidden="true" tabindex="-1"></a>$$y_{ij} = \beta_{0j} + \beta_{1j}x_{ij} + e_{ij}$$</span>
<span id="cb106-732"><a href="#cb106-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-733"><a href="#cb106-733" aria-hidden="true" tabindex="-1"></a>MSOA-level:</span>
<span id="cb106-734"><a href="#cb106-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-735"><a href="#cb106-735" aria-hidden="true" tabindex="-1"></a>$$\beta_{0j} = \beta_{0} + u_{0j}$$ $$\beta_{1j} = \beta_{1} + u_{1j} $$ Replacing the first equation into the second generates:</span>
<span id="cb106-736"><a href="#cb106-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-737"><a href="#cb106-737" aria-hidden="true" tabindex="-1"></a>$$y_{ij} = (\beta_{0} + u_{0j}) + (\beta_{1} + u_{1j})x_{ij} + e_{ij}$$ where, as in the previous Chapter, $y$ the proportion of unemployed population in OA $i$ within MSOA $j$; $\beta_{0}$ is the fixed intercept (averaging over all MSOAs); $u_{0j}$ represents the MSOA-level residuals, or *random effects*, of the intercept; $e_{ij}$ is the individual-level residuals; and, $x_{ij}$ represents the percentage of long-term illness population. *But* now we have a varying slope represented by $\beta_{1}$ and $u_{1j}$: $\beta_{1}$ is estimated average slope - fixed part of the model; and, $u_{1j}$ is the estimated group-level errors of the slope.</span>
<span id="cb106-738"><a href="#cb106-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-739"><a href="#cb106-739" aria-hidden="true" tabindex="-1"></a>To estimate such model, we add <span class="in">`lt_ill`</span> in the bracket with a <span class="in">`+`</span> sign between <span class="in">`1`</span> and <span class="in">`|`</span> i.e. <span class="in">`(1 + lt_ill | msoa_cd)`</span>.</span>
<span id="cb106-740"><a href="#cb106-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-743"><a href="#cb106-743" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-744"><a href="#cb106-744" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb106-745"><a href="#cb106-745" aria-hidden="true" tabindex="-1"></a><span class="co"># attach df</span></span>
<span id="cb106-746"><a href="#cb106-746" aria-hidden="true" tabindex="-1"></a><span class="fu">attach</span>(oa_shp)</span>
<span id="cb106-747"><a href="#cb106-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-748"><a href="#cb106-748" aria-hidden="true" tabindex="-1"></a><span class="co"># change to proportion</span></span>
<span id="cb106-749"><a href="#cb106-749" aria-hidden="true" tabindex="-1"></a>oa_shp<span class="sc">$</span>lt_ill <span class="ot">&lt;-</span> lt_ill<span class="sc">/</span><span class="dv">100</span></span>
<span id="cb106-750"><a href="#cb106-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-751"><a href="#cb106-751" aria-hidden="true" tabindex="-1"></a><span class="co"># specify a model equation</span></span>
<span id="cb106-752"><a href="#cb106-752" aria-hidden="true" tabindex="-1"></a>eq6 <span class="ot">&lt;-</span> unemp <span class="sc">~</span> lt_ill <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> lt_ill <span class="sc">|</span> msoa_cd)</span>
<span id="cb106-753"><a href="#cb106-753" aria-hidden="true" tabindex="-1"></a>model6 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(eq6, <span class="at">data =</span> oa_shp)</span>
<span id="cb106-754"><a href="#cb106-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-755"><a href="#cb106-755" aria-hidden="true" tabindex="-1"></a><span class="co"># estimates</span></span>
<span id="cb106-756"><a href="#cb106-756" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model6)</span>
<span id="cb106-757"><a href="#cb106-757" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-758"><a href="#cb106-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-759"><a href="#cb106-759" aria-hidden="true" tabindex="-1"></a>In this model, the estimated standard deviation of the unexplained within-MSOA variation is 0.04974, and the estimated standard deviation of the MSOA intercepts is 0.05855. But, additionally, we also have estimates of standard deviation of the MSOA slopes (0.17154) and correlation between MSOA-level residuals for the intercept and slope (-0.73). While the former measures the extent of average deviation in the slopes across MSOAs, the latter indicates that the intercept and slope MSOA-level residuals are negatively associated; that is, MSOAs with large slopes have relatively smaller intercepts and *vice versa*. We will come back to this in Section <span class="co">[</span><span class="ot">Interpreting Correlations Between Group-level Intercepts and Slopes</span><span class="co">]</span>.</span>
<span id="cb106-760"><a href="#cb106-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-761"><a href="#cb106-761" aria-hidden="true" tabindex="-1"></a>Similarly, the correlation of fixed effects indicates a negative relationship between the intercept and slope of the average regression model; that is, as the average model intercept tends to increase, the average strength of the relationship between unemployment rate and long-term illness decreases and *vice versa*.</span>
<span id="cb106-762"><a href="#cb106-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-763"><a href="#cb106-763" aria-hidden="true" tabindex="-1"></a>We then explore the estimated average coefficients (*fixed effects*):</span>
<span id="cb106-764"><a href="#cb106-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-767"><a href="#cb106-767" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-768"><a href="#cb106-768" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(model6)</span>
<span id="cb106-769"><a href="#cb106-769" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-770"><a href="#cb106-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-771"><a href="#cb106-771" aria-hidden="true" tabindex="-1"></a>yields an estimated regression line in an average LSOA: $y = 0.04764998 + 0.30125916x$. The fixed intercept indicates that the average unemployment rate is 0.05 if the percentage of population with long-term illness is zero.The fixed slope indicates that the average relationship between unemployment rate and long-term illness is positive across MSOAs i.e. as the percentage of population with long-term illness increases by 1 percentage point, the unemployment rate increases by 0.3.</span>
<span id="cb106-772"><a href="#cb106-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-773"><a href="#cb106-773" aria-hidden="true" tabindex="-1"></a>We look the estimated MSOA-level errors (*random effects*):</span>
<span id="cb106-774"><a href="#cb106-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-777"><a href="#cb106-777" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-778"><a href="#cb106-778" aria-hidden="true" tabindex="-1"></a>ranef_m6 <span class="ot">&lt;-</span> <span class="fu">ranef</span>(model6)</span>
<span id="cb106-779"><a href="#cb106-779" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ranef_m6<span class="sc">$</span>msoa_cd, <span class="dv">5</span>)</span>
<span id="cb106-780"><a href="#cb106-780" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-781"><a href="#cb106-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-782"><a href="#cb106-782" aria-hidden="true" tabindex="-1"></a>Recall these estimates indicate the extent of deviation of the MSOA-specific intercept and slope from the estimated model average captured by the fixed model component.</span>
<span id="cb106-783"><a href="#cb106-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-784"><a href="#cb106-784" aria-hidden="true" tabindex="-1"></a>We can also regain the estimated intercept and slope for each county by adding the estimated MSOA-level errors to the estimated average coefficients; or by executing:</span>
<span id="cb106-785"><a href="#cb106-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-788"><a href="#cb106-788" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-789"><a href="#cb106-789" aria-hidden="true" tabindex="-1"></a><span class="co">#coef(model6)</span></span>
<span id="cb106-790"><a href="#cb106-790" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-791"><a href="#cb106-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-792"><a href="#cb106-792" aria-hidden="true" tabindex="-1"></a>We are normally more interested in identifying the extent of deviation and its significance. To this end, we create a caterpillar plot:</span>
<span id="cb106-793"><a href="#cb106-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-796"><a href="#cb106-796" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-797"><a href="#cb106-797" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb106-798"><a href="#cb106-798" aria-hidden="true" tabindex="-1"></a><span class="fu">plotREsim</span>(<span class="fu">REsim</span>(model6))</span>
<span id="cb106-799"><a href="#cb106-799" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-800"><a href="#cb106-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-801"><a href="#cb106-801" aria-hidden="true" tabindex="-1"></a>These plots reveal some interesting patterns. First, only one MSOA, containing wards such as Tuebrook and Stoneycroft, Anfield &amp; Everton, seems to have a statistically significantly different intercept, or average unemployment rate. Confidence intervals overlap zero for all other 60 MSOAs. Despite this, note that when a slope is allowed to vary by group, it generally makes sense for the intercept to also vary. Second, significant variability exists in the association between unemployment rate and long-term illness across MSOAs. Ten MSOAs display a significant positive association, while 12 exhibit a significantly negative relationship. Third, these results reveal that geographical differences in the relationship between unemployment rate and long-term illness can explain the significant differences in average unemployment rates in the varying intercept only model.</span>
<span id="cb106-802"><a href="#cb106-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-803"><a href="#cb106-803" aria-hidden="true" tabindex="-1"></a>Let's try to get a better understanding of the varying relationship between unemployment rate and long-term illness by mapping the relevant MSOA-level errors.</span>
<span id="cb106-804"><a href="#cb106-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-807"><a href="#cb106-807" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-808"><a href="#cb106-808" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb106-809"><a href="#cb106-809" aria-hidden="true" tabindex="-1"></a><span class="co"># read data</span></span>
<span id="cb106-810"><a href="#cb106-810" aria-hidden="true" tabindex="-1"></a>msoa_shp <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/mlm/MSOA.shp"</span>)</span>
<span id="cb106-811"><a href="#cb106-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-812"><a href="#cb106-812" aria-hidden="true" tabindex="-1"></a><span class="co"># create a dataframe for MSOA-level random effects</span></span>
<span id="cb106-813"><a href="#cb106-813" aria-hidden="true" tabindex="-1"></a>re_msoa_m6 <span class="ot">&lt;-</span> <span class="fu">REsim</span>(model6) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(groupFctr <span class="sc">==</span> <span class="st">"msoa_cd"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb106-814"><a href="#cb106-814" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"lt_ill"</span>)</span>
<span id="cb106-815"><a href="#cb106-815" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(re_msoa_m6)</span>
<span id="cb106-816"><a href="#cb106-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-817"><a href="#cb106-817" aria-hidden="true" tabindex="-1"></a><span class="co"># merge data</span></span>
<span id="cb106-818"><a href="#cb106-818" aria-hidden="true" tabindex="-1"></a>msoa_shp <span class="ot">&lt;-</span> <span class="fu">merge</span>(<span class="at">x =</span> msoa_shp, <span class="at">y =</span> re_msoa_m6, <span class="at">by.x =</span> <span class="st">"MSOA_CD"</span>, <span class="at">by.y =</span> <span class="st">"groupID"</span>)</span>
<span id="cb106-819"><a href="#cb106-819" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-820"><a href="#cb106-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-823"><a href="#cb106-823" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-824"><a href="#cb106-824" aria-hidden="true" tabindex="-1"></a><span class="co"># ensure geometry is valid</span></span>
<span id="cb106-825"><a href="#cb106-825" aria-hidden="true" tabindex="-1"></a>msoa_shp <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_make_valid</span>(msoa_shp)</span>
<span id="cb106-826"><a href="#cb106-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-827"><a href="#cb106-827" aria-hidden="true" tabindex="-1"></a><span class="co"># create a map</span></span>
<span id="cb106-828"><a href="#cb106-828" aria-hidden="true" tabindex="-1"></a>legend_title <span class="ot">=</span> <span class="fu">expression</span>(<span class="st">"MSOA-level residuals"</span>)</span>
<span id="cb106-829"><a href="#cb106-829" aria-hidden="true" tabindex="-1"></a>map_msoa <span class="ot">=</span> <span class="fu">tm_shape</span>(msoa_shp) <span class="sc">+</span></span>
<span id="cb106-830"><a href="#cb106-830" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="at">col =</span> <span class="st">"median"</span>, <span class="at">title =</span> legend_title, <span class="at">palette =</span> <span class="fu">magma</span>(<span class="dv">256</span>, <span class="at">begin =</span> <span class="dv">0</span>, <span class="at">end =</span> <span class="dv">1</span>), <span class="at">style =</span> <span class="st">"cont"</span>) <span class="sc">+</span> </span>
<span id="cb106-831"><a href="#cb106-831" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> .<span class="dv">01</span>)  <span class="sc">+</span> </span>
<span id="cb106-832"><a href="#cb106-832" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_compass</span>(<span class="at">type =</span> <span class="st">"arrow"</span>, <span class="at">position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"top"</span>) , <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span> </span>
<span id="cb106-833"><a href="#cb106-833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_scale_bar</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">text.size =</span> <span class="fl">0.5</span>, <span class="at">position =</span>  <span class="fu">c</span>(<span class="st">"center"</span>, <span class="st">"bottom"</span>)) </span>
<span id="cb106-834"><a href="#cb106-834" aria-hidden="true" tabindex="-1"></a>map_msoa</span>
<span id="cb106-835"><a href="#cb106-835" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-836"><a href="#cb106-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-837"><a href="#cb106-837" aria-hidden="true" tabindex="-1"></a>The map indicates that the relationship between unemployment rate and long-term illness is tends to stronger and positive in northern MSOAs; that is, the percentage of population with long-term illness explains a greater share of the variation in unemployment rates in these locations. As expected, a greater share of population in long-term illness is associated with higher local unemployment. In contrast, the relationship between unemployment rate and long-term illness tends to operate in the reverse direction in north-east and middle-southern MSOAs. In these MSOAs, OAs tend to have a higher unemployment rate relative the share of population in long-term illness. You can confirm this examining the data for specific MSOA executing:</span>
<span id="cb106-838"><a href="#cb106-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-841"><a href="#cb106-841" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-842"><a href="#cb106-842" aria-hidden="true" tabindex="-1"></a>oa_shp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(msoa_cd, ward_nm, unemp, lt_ill) <span class="sc">%&gt;%</span></span>
<span id="cb106-843"><a href="#cb106-843" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">as.character</span>(msoa_cd) <span class="sc">==</span> <span class="st">"E02001370"</span>)</span>
<span id="cb106-844"><a href="#cb106-844" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-845"><a href="#cb106-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-846"><a href="#cb106-846" aria-hidden="true" tabindex="-1"></a>Now try adding a group-level predictor and an individual-level predictor to the model. Unsure, look at @sec-indlevel and @sec-grouplevel in @sec-chp7.</span>
<span id="cb106-847"><a href="#cb106-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-848"><a href="#cb106-848" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interpreting Correlations Between Group-level Intercepts and Slopes</span></span>
<span id="cb106-849"><a href="#cb106-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-850"><a href="#cb106-850" aria-hidden="true" tabindex="-1"></a>Correlations of random effects are confusing to interpret. Key for their appropriate interpretation is to recall they refer to group-level residuals i.e. deviation of intercepts and slopes from the average model intercept and slope. A strong *negative* correlation indicates that groups with high intercepts have relatively low slopes, and *vice versa*. A strong *positive* correlation indicates that groups with high intercepts have relatively high slopes, and *vice versa*. A correlation close to *zero* indicate little or no systematic between intercepts and slopes. Note that a high correlation between intercepts and slopes is not a problem, but it makes the interpretation of the estimated intercepts more challenging. For this reason, a suggestion is to center predictors ($x's$); that is, substract their average value ($z = x - \bar{x}$). For a more detailed discussion, see @bristol2020.</span>
<span id="cb106-851"><a href="#cb106-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-852"><a href="#cb106-852" aria-hidden="true" tabindex="-1"></a>To illustrate this, let's reestimate our model adding an individual-level predictor: the share of population with no educational qualification.</span>
<span id="cb106-853"><a href="#cb106-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-856"><a href="#cb106-856" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-857"><a href="#cb106-857" aria-hidden="true" tabindex="-1"></a><span class="co"># centering to the mean</span></span>
<span id="cb106-858"><a href="#cb106-858" aria-hidden="true" tabindex="-1"></a>oa_shp<span class="sc">$</span>z_no_qual <span class="ot">&lt;-</span> no_qual<span class="sc">/</span><span class="dv">100</span> <span class="sc">-</span> <span class="fu">mean</span>(no_qual<span class="sc">/</span><span class="dv">100</span>)</span>
<span id="cb106-859"><a href="#cb106-859" aria-hidden="true" tabindex="-1"></a>oa_shp<span class="sc">$</span>z_lt_ill <span class="ot">&lt;-</span> lt_ill <span class="sc">-</span> <span class="fu">mean</span>(lt_ill)</span>
<span id="cb106-860"><a href="#cb106-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-861"><a href="#cb106-861" aria-hidden="true" tabindex="-1"></a><span class="co"># specify a model equation</span></span>
<span id="cb106-862"><a href="#cb106-862" aria-hidden="true" tabindex="-1"></a>eq7 <span class="ot">&lt;-</span> unemp <span class="sc">~</span> z_lt_ill <span class="sc">+</span> z_no_qual <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> z_lt_ill <span class="sc">|</span> msoa_cd)</span>
<span id="cb106-863"><a href="#cb106-863" aria-hidden="true" tabindex="-1"></a>model7 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(eq7, <span class="at">data =</span> oa_shp)</span>
<span id="cb106-864"><a href="#cb106-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-865"><a href="#cb106-865" aria-hidden="true" tabindex="-1"></a><span class="co"># estimates</span></span>
<span id="cb106-866"><a href="#cb106-866" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model7)</span>
<span id="cb106-867"><a href="#cb106-867" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-868"><a href="#cb106-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-869"><a href="#cb106-869" aria-hidden="true" tabindex="-1"></a>How do you interpret the random effect correlation?</span>
<span id="cb106-870"><a href="#cb106-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-871"><a href="#cb106-871" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model building</span></span>
<span id="cb106-872"><a href="#cb106-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-873"><a href="#cb106-873" aria-hidden="true" tabindex="-1"></a>Now we know how to estimate multilevel regression models in *R*. The question that remains is: *When does multilevel modeling make a difference?* The short answer is: when there is little group-level variation. When there is very little group-level variation, the multilevel modelling reduces to classical linear regression estimates *with no group indicators*. Inversely, when group-level coefficients vary greatly (compared to their standard errors of estimation), multilevel modelling reduces to classical regression *with group indicators* @gelman2006data.</span>
<span id="cb106-874"><a href="#cb106-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-875"><a href="#cb106-875" aria-hidden="true" tabindex="-1"></a>*How do you go about building a model?*</span>
<span id="cb106-876"><a href="#cb106-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-877"><a href="#cb106-877" aria-hidden="true" tabindex="-1"></a>We generally start simple by fitting simple linear regressions and then work our way up to a full multilevel model - see @gelman2006data p. 270.</span>
<span id="cb106-878"><a href="#cb106-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-879"><a href="#cb106-879" aria-hidden="true" tabindex="-1"></a>*How many groups are needed?*</span>
<span id="cb106-880"><a href="#cb106-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-881"><a href="#cb106-881" aria-hidden="true" tabindex="-1"></a>As an absolute minimum, more than two groups are required. With only one or two groups, a multilevel model reduces to a linear regression model.</span>
<span id="cb106-882"><a href="#cb106-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-883"><a href="#cb106-883" aria-hidden="true" tabindex="-1"></a>*How many observations per group?*</span>
<span id="cb106-884"><a href="#cb106-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-885"><a href="#cb106-885" aria-hidden="true" tabindex="-1"></a>Two observations per group is sufficient to fit a multilevel model.</span>
<span id="cb106-886"><a href="#cb106-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-887"><a href="#cb106-887" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model Comparison</span></span>
<span id="cb106-888"><a href="#cb106-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-889"><a href="#cb106-889" aria-hidden="true" tabindex="-1"></a>*How we assess different candidate models?* We can use the function `anova()` and assess various statistics: The Akaike Information Criterion (AIC), the Bayesian Information Criterion (BIC), Loglik and Deviance. Generally, we look for lower scores for all these indicators. We can also refer to the *Chisq* statistic below. It tests the hypothesis of whether additional predictors improve model fit. Particularly it tests the *Null Hypothesis* whether the coefficients of the additional predictors equal 0. It does so comparing the deviance statistic and determining if changes in the deviance are statistically significant. Note that a major limitation of the deviance test is that it is for nested models i.e. a model being compared must be nested in the other. Below we compare our two models. The results indicate that adding an individual-level predictor (i.e. the share of population with no qualification) provides a model with better.</span>
<span id="cb106-890"><a href="#cb106-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-893"><a href="#cb106-893" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-894"><a href="#cb106-894" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(model6, model7)</span>
<span id="cb106-895"><a href="#cb106-895" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-896"><a href="#cb106-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-897"><a href="#cb106-897" aria-hidden="true" tabindex="-1"></a><span class="fu">## Questions</span></span>
<span id="cb106-898"><a href="#cb106-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-899"><a href="#cb106-899" aria-hidden="true" tabindex="-1"></a>We will continue to use the COVID-19 dataset. Please see @sec-chp11 for details on the data.</span>
<span id="cb106-900"><a href="#cb106-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-903"><a href="#cb106-903" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-904"><a href="#cb106-904" aria-hidden="true" tabindex="-1"></a>sdf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/assignment_2_covid/covid19_eng.gpkg"</span>)</span>
<span id="cb106-905"><a href="#cb106-905" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-906"><a href="#cb106-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-907"><a href="#cb106-907" aria-hidden="true" tabindex="-1"></a>Using these data, you are required to address the following challenges:</span>
<span id="cb106-908"><a href="#cb106-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-909"><a href="#cb106-909" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Fit a varying-slope model. Let one slope to vary by region. Think carefully your choice.</span>
<span id="cb106-910"><a href="#cb106-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-911"><a href="#cb106-911" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Fit a varying-intercept and varying-slope model.</span>
<span id="cb106-912"><a href="#cb106-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-913"><a href="#cb106-913" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Compare the results for models fitted in 1 and 2. Which is better? Why?</span>
<span id="cb106-914"><a href="#cb106-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-915"><a href="#cb106-915" aria-hidden="true" tabindex="-1"></a>Use the same explanatory variables used for the @sec-chp7 challenge, so you can compare the model results from this chapter.</span>
<span id="cb106-916"><a href="#cb106-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-917"><a href="#cb106-917" aria-hidden="true" tabindex="-1"></a>Analyse and discuss:</span>
<span id="cb106-918"><a href="#cb106-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-919"><a href="#cb106-919" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>the varying slope estimate(s) from your model(s) (to what extent does the relationship between your dependent and independent variables vary across groups / areas? are they statistically significantly different?).</span>
<span id="cb106-920"><a href="#cb106-920" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>differences between your varying intercept and varying slope models.</span>
<span id="cb106-921"><a href="#cb106-921" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">All content licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> <br> © <a href="https://www.franciscorowe.com">Francisco Rowe</a>, <a href="https://darribas.org">Dani Arribas-Bel</a>.</div>   
      <div class="nav-footer-center"><a href="https://fcorowe.github.io/smds/">Website</a> | <a href="https://github.com/fcorowe/smds">GitHub</a></div>
    <div class="nav-footer-right">Built with <a href="https://quarto.org/">Quarto</a>.</div>
  </div>
</footer>


<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>